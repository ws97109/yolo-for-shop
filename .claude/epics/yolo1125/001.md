---
name: 建立專案結構與 MongoDB 設定
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: false
conflicts_with: []
---

# Task: 建立專案結構與 MongoDB 設定

## Description

建立 yolo1125 專案的基礎架構，包括目錄結構、MongoDB 資料庫設定與初始化腳本，以及 Python 依賴套件管理。這是整個系統的基礎，所有後續任務都依賴此架構。

**核心目標**：
- 建立模組化的專案目錄結構
- 設定 MongoDB 本地資料庫
- 建立三個 Collections：Users, Products, Transactions
- 初始化商品資料（元翠茶、分解茶）
- 準備 requirements.txt

## Acceptance Criteria

- [ ] 專案目錄結構完整建立（backend/, frontend/, data/, scripts/）
- [ ] MongoDB 本地服務成功啟動並可連線
- [ ] 三個 Collections 成功建立並有適當索引
- [ ] Products Collection 包含元翠茶和分解茶的初始資料
- [ ] requirements.txt 包含所有必要套件
- [ ] 執行 `python scripts/init_db.py` 成功初始化資料庫
- [ ] README.md 包含專案說明和環境設定步驟

## Technical Details

### 專案結構
```
yolo1125/
├── backend/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   ├── database.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── product.py
│   │   └── transaction.py
│   └── services/
│       ├── __init__.py
│       ├── face_service.py
│       ├── yolo_service.py
│       └── cart_service.py
├── frontend/
│   ├── index.html
│   └── static/
│       ├── css/
│       │   └── style.css
│       └── js/
│           ├── camera.js
│           ├── websocket.js
│           └── cart.js
├── data/
│   └── faces/
│       └── .gitkeep
├── scripts/
│   └── init_db.py
├── requirements.txt
├── .gitignore
└── README.md
```

### MongoDB Collections 設計

**Users Collection**:
```python
{
    "_id": ObjectId,
    "name": str,              # 姓名
    "phone": str,             # 電話
    "face_encoding": list,    # 128-d 人臉特徵向量
    "face_image_path": str,   # 人臉圖片路徑 (data/faces/{user_id}.jpg)
    "created_at": datetime,
    "last_visit": datetime
}
# 索引: phone (unique)
```

**Products Collection**:
```python
{
    "_id": ObjectId,
    "name": str,              # 商品名稱
    "price": float,           # 價格
    "yolo_class_id": int,     # YOLO 模型類別 ID
    "yolo_class_name": str,   # YOLO 類別名稱
    "image": str,             # 商品圖片 (選填)
    "created_at": datetime
}
# 索引: yolo_class_id (unique)
```

**Transactions Collection**:
```python
{
    "_id": ObjectId,
    "user_id": ObjectId,      # 關聯 Users._id
    "user_name": str,         # 冗餘儲存
    "items": [
        {
            "product_id": ObjectId,
            "product_name": str,
            "quantity": int,
            "unit_price": float,
            "subtotal": float
        }
    ],
    "total_quantity": int,
    "total_amount": float,
    "created_at": datetime
}
# 索引: user_id, created_at
```

### 初始商品資料
```python
products = [
    {
        "name": "元翠茶",
        "price": 150.0,
        "yolo_class_id": 0,
        "yolo_class_name": "yuancui_tea",
        "created_at": datetime.utcnow()
    },
    {
        "name": "分解茶",
        "price": 200.0,
        "yolo_class_id": 1,
        "yolo_class_name": "fenjie_tea",
        "created_at": datetime.utcnow()
    }
]
```

### config.py 範例
```python
import os
from pathlib import Path

# 專案根目錄
BASE_DIR = Path(__file__).parent.parent

# MongoDB 設定
MONGODB_URL = os.getenv("MONGODB_URL", "mongodb://localhost:27017")
DB_NAME = "yolo1125"

# YOLO 模型設定
YOLO_MODEL_PATH = BASE_DIR / "runs" / "detect" / "train" / "weights" / "best.pt"
CONFIDENCE_THRESHOLD = 0.7

# 人臉圖片儲存
FACE_IMAGES_DIR = BASE_DIR / "data" / "faces"

# 人臉識別設定
FACE_MATCH_TOLERANCE = 0.6  # 越小越嚴格

# WebSocket 設定
WS_FRAME_RATE = 5  # 每秒處理 5 影格
```

### database.py 範例
```python
from pymongo import MongoClient, ASCENDING
from pymongo.errors import ConnectionFailure
from backend.config import MONGODB_URL, DB_NAME

class Database:
    client = None
    db = None

    @classmethod
    def connect(cls):
        """連接 MongoDB"""
        try:
            cls.client = MongoClient(MONGODB_URL, serverSelectionTimeoutMS=5000)
            cls.client.admin.command('ping')
            cls.db = cls.client[DB_NAME]
            print(f"✅ MongoDB 連線成功: {DB_NAME}")
            return cls.db
        except ConnectionFailure as e:
            print(f"❌ MongoDB 連線失敗: {e}")
            raise

    @classmethod
    def get_db(cls):
        """取得資料庫連線"""
        if cls.db is None:
            cls.connect()
        return cls.db

    @classmethod
    def close(cls):
        """關閉連線"""
        if cls.client:
            cls.client.close()
            print("MongoDB 連線已關閉")

def init_collections():
    """初始化 Collections 和索引"""
    db = Database.get_db()

    # Users Collection
    db.users.create_index([("phone", ASCENDING)], unique=True)

    # Products Collection
    db.products.create_index([("yolo_class_id", ASCENDING)], unique=True)

    # Transactions Collection
    db.transactions.create_index([("user_id", ASCENDING)])
    db.transactions.create_index([("created_at", ASCENDING)])

    print("✅ Collections 索引建立完成")
```

### init_db.py 範例
```python
import sys
from pathlib import Path
from datetime import datetime

# 加入專案路徑
sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.database import Database, init_collections

def main():
    """初始化資料庫"""
    print("開始初始化資料庫...")

    # 連接資料庫
    db = Database.connect()

    # 建立索引
    init_collections()

    # 插入初始商品資料
    products = [
        {
            "name": "元翠茶",
            "price": 150.0,
            "yolo_class_id": 0,
            "yolo_class_name": "yuancui_tea",
            "created_at": datetime.utcnow()
        },
        {
            "name": "分解茶",
            "price": 200.0,
            "yolo_class_id": 1,
            "yolo_class_name": "fenjie_tea",
            "created_at": datetime.utcnow()
        }
    ]

    # 清空現有資料（開發階段）
    db.products.delete_many({})

    # 插入商品
    result = db.products.insert_many(products)
    print(f"✅ 插入 {len(result.inserted_ids)} 個商品")

    # 顯示商品清單
    for product in db.products.find():
        print(f"  - {product['name']}: NT$ {product['price']}")

    print("\n✅ 資料庫初始化完成！")

if __name__ == "__main__":
    main()
```

### requirements.txt
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-multipart==0.0.6
websockets==12.0
pymongo==4.6.0
opencv-python==4.8.1.78
face-recognition==1.3.0
dlib==19.24.2
ultralytics==8.0.220
pillow==10.1.0
numpy==1.24.3
python-dateutil==2.8.2
```

## Dependencies

- [ ] 系統已安裝 MongoDB 6.0+
- [ ] 系統已安裝 Python 3.8+
- [ ] 系統已安裝 CMake（face_recognition 依賴）
- [ ] 現有 YOLO 模型位於 `runs/` 目錄

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 4-6 小時
- **Parallel**: false（此為基礎任務，後續任務都依賴它）

**時間分配**：
- 建立目錄結構：30 分鐘
- 撰寫 config.py 和 database.py：1 小時
- 撰寫 init_db.py：1 小時
- 建立 requirements.txt：30 分鐘
- MongoDB 安裝和設定：1 小時
- 測試和除錯：1-2 小時
- 撰寫 README.md：30 分鐘

## Definition of Done

- [ ] 專案結構建立完成，所有目錄和佔位檔案已建立
- [ ] MongoDB 本地服務運行正常（`mongosh` 可連線）
- [ ] 執行 `python scripts/init_db.py` 成功且無錯誤
- [ ] Products Collection 包含 2 筆商品資料
- [ ] 所有索引建立成功（用 `db.collection.getIndexes()` 驗證）
- [ ] 執行 `pip install -r requirements.txt` 成功安裝所有套件
- [ ] README.md 包含：
  - 專案簡介
  - 環境需求
  - 安裝步驟
  - 資料庫初始化步驟
- [ ] .gitignore 包含：`__pycache__/`, `*.pyc`, `data/faces/*.jpg`, `.env`
- [ ] 程式碼通過基本語法檢查（無明顯錯誤）
