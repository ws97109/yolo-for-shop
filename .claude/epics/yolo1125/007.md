---
name: å¯¦ä½œçµå¸³æµç¨‹èˆ‡äº¤æ˜“è¨˜éŒ„
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: [006]
parallel: false
conflicts_with: []
---

# Task: å¯¦ä½œçµå¸³æµç¨‹èˆ‡äº¤æ˜“è¨˜éŒ„

## Description

å¯¦ä½œå®Œæ•´çš„çµå¸³æµç¨‹ï¼ŒåŒ…æ‹¬é©—è­‰è³¼ç‰©è»Šã€å„²å­˜äº¤æ˜“è¨˜éŒ„è‡³ MongoDBã€æ¸…ç©ºè³¼ç‰©è»Šï¼Œä»¥åŠçµå¸³æˆåŠŸå¾Œçš„è¦–è¦ºå›é¥‹ã€‚é€™æ˜¯è³¼ç‰©æµç¨‹çš„æœ€å¾Œä¸€æ­¥ï¼Œéœ€ç¢ºä¿è³‡æ–™å®Œæ•´æ€§å’Œä½¿ç”¨è€…é«”é©—ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼š
- å¯¦ä½œçµå¸³ API ç«¯é»
- é©—è­‰ä½¿ç”¨è€…å’Œè³¼ç‰©è»Šæœ‰æ•ˆæ€§
- å»ºç«‹äº¤æ˜“è¨˜éŒ„ä¸¦å„²å­˜è‡³ Transactions Collection
- çµå¸³æˆåŠŸå¾Œæ¸…ç©ºè³¼ç‰©è»Š
- å‰ç«¯é¡¯ç¤ºçµå¸³æˆåŠŸè¨Šæ¯
- è¨˜éŒ„è©³ç´°çš„äº¤æ˜“è³‡è¨Š

## Acceptance Criteria

- [ ] é»æ“Šã€Œå®Œæˆçµå¸³ã€æŒ‰éˆ•è§¸ç™¼çµå¸³æµç¨‹
- [ ] é©—è­‰ä½¿ç”¨è€…å·²ç™»å…¥
- [ ] é©—è­‰è³¼ç‰©è»Šä¸ç‚ºç©º
- [ ] äº¤æ˜“è¨˜éŒ„æˆåŠŸå„²å­˜è‡³ MongoDB
- [ ] äº¤æ˜“è¨˜éŒ„åŒ…å«ï¼šä½¿ç”¨è€… IDã€å•†å“æ¸…å–®ã€ç¸½é‡‘é¡ã€æ™‚é–“
- [ ] çµå¸³æˆåŠŸå¾Œè³¼ç‰©è»Šæ¸…ç©º
- [ ] å‰ç«¯é¡¯ç¤ºçµå¸³æˆåŠŸè¨Šæ¯å’Œäº¤æ˜“ ID
- [ ] çµå¸³å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- [ ] äº¤æ˜“è¨˜éŒ„å¯æŸ¥è©¢é©—è­‰

## Technical Details

### çµå¸³æœå‹™ï¼ˆæ•´åˆè‡³ main.pyï¼‰

```python
from bson import ObjectId

@app.post("/api/checkout")
async def checkout(data: dict):
    """è™•ç†çµå¸³"""
    try:
        session_id = data.get("session_id")

        if not session_id:
            raise HTTPException(status_code=400, detail="ç¼ºå°‘ session_id")

        session = manager.get_session(session_id)

        if not session:
            raise HTTPException(status_code=400, detail="Session ä¸å­˜åœ¨")

        user_id = session.get("user_id")
        if not user_id:
            raise HTTPException(status_code=400, detail="ä½¿ç”¨è€…æœªç™»å…¥")

        # é©—è­‰è³¼ç‰©è»Š
        if not cart_service.validate_cart(session_id):
            raise HTTPException(status_code=400, detail="è³¼ç‰©è»Šæ˜¯ç©ºçš„")

        # å–å¾—è³¼ç‰©è»Šè³‡æ–™
        cart_summary = cart_service.get_cart_summary(session_id)

        # å–å¾—ä½¿ç”¨è€…è³‡è¨Š
        user = face_service.get_user_by_id(user_id)
        if not user:
            raise HTTPException(status_code=400, detail="ä½¿ç”¨è€…ä¸å­˜åœ¨")

        # å»ºç«‹äº¤æ˜“è¨˜éŒ„
        transaction = {
            "user_id": ObjectId(user_id),
            "user_name": user['name'],
            "items": cart_summary['items'],
            "total_quantity": cart_summary['total_quantity'],
            "total_amount": cart_summary['total_amount'],
            "created_at": datetime.utcnow()
        }

        db = Database.get_db()
        result = db.transactions.insert_one(transaction)
        transaction_id = str(result.inserted_id)

        # æ¸…ç©ºè³¼ç‰©è»Š
        cart_service.clear_cart(session_id)

        # ç™¼é€è³¼ç‰©è»Šæ›´æ–°ï¼ˆæ¸…ç©ºï¼‰
        await manager.send_message(session_id, {
            "type": "cart_updated",
            "cart": {
                "items": [],
                "total_quantity": 0,
                "total_amount": 0
            }
        })

        print(f"âœ… çµå¸³æˆåŠŸ: {user['name']} - NT$ {cart_summary['total_amount']}")

        return JSONResponse(content={
            "success": True,
            "message": "çµå¸³æˆåŠŸ",
            "transaction_id": transaction_id,
            "total_amount": cart_summary['total_amount']
        })

    except HTTPException:
        raise
    except Exception as e:
        print(f"âŒ çµå¸³å¤±æ•—: {e}")
        raise HTTPException(status_code=500, detail=f"çµå¸³å¤±æ•—: {str(e)}")

# æ–°å¢æŸ¥è©¢äº¤æ˜“è¨˜éŒ„ç«¯é»
@app.get("/api/transactions/{user_id}")
async def get_user_transactions(user_id: str):
    """æŸ¥è©¢ä½¿ç”¨è€…çš„äº¤æ˜“è¨˜éŒ„"""
    try:
        db = Database.get_db()
        transactions = list(db.transactions.find(
            {"user_id": ObjectId(user_id)},
            {"_id": 1, "created_at": 1, "total_amount": 1, "total_quantity": 1}
        ).sort("created_at", -1).limit(10))

        # è½‰æ› ObjectId å’Œ datetime
        for txn in transactions:
            txn['_id'] = str(txn['_id'])
            txn['created_at'] = txn['created_at'].isoformat()

        return JSONResponse(content={"transactions": transactions})

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"æŸ¥è©¢å¤±æ•—: {str(e)}")
```

### è³‡æ–™æ¨¡å‹ï¼ˆmodels/transaction.pyï¼‰

```python
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime
from bson import ObjectId

class TransactionItem(BaseModel):
    """äº¤æ˜“å•†å“é …ç›®"""
    product_id: str
    product_name: str
    quantity: int
    unit_price: float
    subtotal: float

class Transaction(BaseModel):
    """äº¤æ˜“è¨˜éŒ„"""
    id: Optional[str] = Field(None, alias='_id')
    user_id: str
    user_name: str
    items: List[TransactionItem]
    total_quantity: int
    total_amount: float
    created_at: datetime = Field(default_factory=datetime.utcnow)

    class Config:
        populate_by_name = True
        json_encoders = {
            datetime: lambda v: v.isoformat(),
            ObjectId: lambda v: str(v)
        }
```

### å‰ç«¯çµå¸³åŠŸèƒ½ï¼ˆæ›´æ–° cart.jsï¼‰

```javascript
class Cart {
    // ... å…¶ä»–æ–¹æ³• ...

    async checkout() {
        if (this.items.length === 0) {
            alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•çµå¸³');
            return;
        }

        // ç¢ºèªçµå¸³
        const confirmed = confirm(
            `ç¢ºèªçµå¸³ï¼Ÿ\n\n` +
            `å•†å“æ•¸é‡ï¼š${this.totalQuantity}\n` +
            `ç¸½é‡‘é¡ï¼šNT$ ${this.totalAmount}`
        );

        if (!confirmed) return;

        try {
            // ç™¼é€çµå¸³è«‹æ±‚
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: wsClient.sessionId
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // çµå¸³æˆåŠŸ
                this.showCheckoutSuccess(data);
            } else {
                // çµå¸³å¤±æ•—
                alert('çµå¸³å¤±æ•—ï¼š' + (data.detail || data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }

        } catch (err) {
            console.error('âŒ çµå¸³éŒ¯èª¤:', err);
            alert('çµå¸³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        }
    }

    showCheckoutSuccess(data) {
        // å»ºç«‹æˆåŠŸè¨Šæ¯
        const message = `
            âœ… çµå¸³æˆåŠŸï¼

            äº¤æ˜“ç·¨è™Ÿï¼š${data.transaction_id.substring(0, 8)}...
            ç¸½é‡‘é¡ï¼šNT$ ${data.total_amount}

            æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼
        `;

        alert(message);

        // æ¸…ç©ºæœ¬åœ°è³¼ç‰©è»Š
        this.clear();

        console.log('âœ… çµå¸³æˆåŠŸ:', data);
    }
}
```

### æ›´æ–° index.htmlï¼ˆåŠ å…¥çµå¸³æˆåŠŸæ¨¡æ…‹æ¡†ï¼‰

å¯é¸ï¼šæ›´ç¾è§€çš„æˆåŠŸè¨Šæ¯é¡¯ç¤º

```html
<!-- çµå¸³æˆåŠŸæ¨¡æ…‹æ¡† -->
<div id="checkout-success-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="success-icon">âœ…</div>
        <h2>çµå¸³æˆåŠŸï¼</h2>
        <div id="checkout-details"></div>
        <button class="btn-primary" onclick="closeCheckoutModal()">ç¢ºå®š</button>
    </div>
</div>
```

CSS æ¨£å¼ï¼š

```css
/* æ¨¡æ…‹æ¡† */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: white;
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.success-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.modal-content h2 {
    margin-bottom: 20px;
    color: var(--primary-color);
}

#checkout-details {
    margin-bottom: 30px;
    text-align: left;
    background: var(--background);
    padding: 15px;
    border-radius: 6px;
}

#checkout-details p {
    margin: 8px 0;
}
```

JavaScriptï¼š

```javascript
function showCheckoutSuccess(data) {
    const modal = document.getElementById('checkout-success-modal');
    const detailsEl = document.getElementById('checkout-details');

    detailsEl.innerHTML = `
        <p><strong>äº¤æ˜“ç·¨è™Ÿï¼š</strong>${data.transaction_id.substring(0, 12)}...</p>
        <p><strong>ç¸½é‡‘é¡ï¼š</strong>NT$ ${data.total_amount}</p>
        <p><strong>æ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-TW')}</p>
    `;

    modal.style.display = 'flex';

    // æ¸…ç©ºè³¼ç‰©è»Š
    cart.clear();
}

function closeCheckoutModal() {
    document.getElementById('checkout-success-modal').style.display = 'none';
}
```

### æ¸¬è©¦è…³æœ¬

```python
# scripts/test_checkout.py
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.database import Database
from backend.services.cart_service import cart_service
from backend.services.face_service import face_service
from bson import ObjectId
from datetime import datetime

def test_checkout():
    """æ¸¬è©¦çµå¸³æµç¨‹"""
    print("é–‹å§‹æ¸¬è©¦çµå¸³...")

    db = Database.connect()

    # å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…
    test_user = {
        "name": "æ¸¬è©¦ä½¿ç”¨è€…",
        "phone": "0900000000",
        "face_encoding": [0.0] * 128,
        "face_image_path": "",
        "created_at": datetime.utcnow(),
        "last_visit": datetime.utcnow()
    }

    result = db.users.insert_one(test_user)
    user_id = str(result.inserted_id)
    print(f"âœ… å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…: {user_id}")

    # å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š
    session_id = "test_checkout_session"
    product1 = {'id': 'prod1', 'name': 'å…ƒç¿ èŒ¶', 'price': 150.0}
    product2 = {'id': 'prod2', 'name': 'åˆ†è§£èŒ¶', 'price': 200.0}

    cart_service.add_item(session_id, product1)
    cart_service.add_item(session_id, product1)
    cart_service.add_item(session_id, product2)

    cart_summary = cart_service.get_cart_summary(session_id)
    print(f"âœ… è³¼ç‰©è»Š: {cart_summary}")

    # æ¨¡æ“¬çµå¸³
    transaction = {
        "user_id": ObjectId(user_id),
        "user_name": test_user['name'],
        "items": cart_summary['items'],
        "total_quantity": cart_summary['total_quantity'],
        "total_amount": cart_summary['total_amount'],
        "created_at": datetime.utcnow()
    }

    result = db.transactions.insert_one(transaction)
    transaction_id = str(result.inserted_id)
    print(f"âœ… äº¤æ˜“è¨˜éŒ„å·²å„²å­˜: {transaction_id}")

    # é©—è­‰äº¤æ˜“è¨˜éŒ„
    saved_txn = db.transactions.find_one({"_id": result.inserted_id})
    print(f"âœ… é©—è­‰äº¤æ˜“è¨˜éŒ„: {saved_txn['total_amount']} å…ƒ")

    # æ¸…ç†æ¸¬è©¦è³‡æ–™
    db.users.delete_one({"_id": ObjectId(user_id)})
    db.transactions.delete_one({"_id": result.inserted_id})
    print("ğŸ§¹ æ¸…ç†æ¸¬è©¦è³‡æ–™")

    print("\nâœ… çµå¸³æ¸¬è©¦å®Œæˆ")

if __name__ == "__main__":
    test_checkout()
```

### æŸ¥è©¢äº¤æ˜“è¨˜éŒ„æ¸¬è©¦

```python
# scripts/view_transactions.py
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.database import Database

def view_transactions():
    """æŸ¥çœ‹æœ€è¿‘çš„äº¤æ˜“è¨˜éŒ„"""
    db = Database.connect()

    print("æœ€è¿‘ 10 ç­†äº¤æ˜“è¨˜éŒ„ï¼š\n")

    transactions = db.transactions.find().sort("created_at", -1).limit(10)

    for i, txn in enumerate(transactions, 1):
        print(f"{i}. {txn['user_name']}")
        print(f"   æ™‚é–“ï¼š{txn['created_at'].strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"   å•†å“ï¼š")
        for item in txn['items']:
            print(f"     - {item['product_name']} x{item['quantity']}")
        print(f"   ç¸½é‡‘é¡ï¼šNT$ {txn['total_amount']}")
        print(f"   äº¤æ˜“ IDï¼š{txn['_id']}\n")

if __name__ == "__main__":
    view_transactions()
```

## Dependencies

- [ ] Task 006 å®Œæˆï¼ˆè³¼ç‰©è»ŠåŠŸèƒ½ï¼‰
- [ ] MongoDB Transactions Collection å·²å»ºç«‹
- [ ] ä½¿ç”¨è€…å·²ç™»å…¥
- [ ] è³¼ç‰©è»Šæœ‰å•†å“

## Effort Estimate

- **Size**: S (Small)
- **Hours**: 2-3 å°æ™‚
- **Parallel**: falseï¼ˆä¾è³´ Task 006ï¼‰

**æ™‚é–“åˆ†é…**ï¼š
- çµå¸³ API å¯¦ä½œï¼š1 å°æ™‚
- å‰ç«¯çµå¸³åŠŸèƒ½ï¼š30 åˆ†é˜
- äº¤æ˜“è¨˜éŒ„æŸ¥è©¢ï¼š30 åˆ†é˜
- æ¸¬è©¦å’Œé©—è­‰ï¼š1 å°æ™‚

## Definition of Done

- [ ] åŸ·è¡Œ `python scripts/test_checkout.py` æ¸¬è©¦é€šé
- [ ] å•Ÿå‹•ç³»çµ±ï¼Œå®Œæ•´åŸ·è¡Œè³¼ç‰©æµç¨‹ï¼ˆç™»å…¥ â†’ æƒå•†å“ â†’ çµå¸³ï¼‰
- [ ] é»æ“Šã€Œå®Œæˆçµå¸³ã€æŒ‰éˆ•ï¼Œå‡ºç¾ç¢ºèªå°è©±æ¡†
- [ ] ç¢ºèªå¾Œçµå¸³æˆåŠŸï¼Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯
- [ ] MongoDB Transactions Collection åŒ…å«æ–°äº¤æ˜“è¨˜éŒ„
- [ ] äº¤æ˜“è¨˜éŒ„æ¬„ä½å®Œæ•´ï¼ˆä½¿ç”¨è€…ã€å•†å“ã€é‡‘é¡ã€æ™‚é–“ï¼‰
- [ ] çµå¸³å¾Œè³¼ç‰©è»Šæ¸…ç©º
- [ ] åŸ·è¡Œ `python scripts/view_transactions.py` å¯æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
- [ ] çµå¸³å¤±æ•—æ™‚ï¼ˆä¾‹å¦‚è³¼ç‰©è»Šç©ºï¼‰é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- [ ] Console æ­£ç¢ºé¡¯ç¤ºçµå¸³æ—¥èªŒ
- [ ] äº¤æ˜“è¨˜éŒ„çš„ user_id å¯æ­£ç¢ºé—œè¯è‡³ Users Collection
- [ ] ç¸½é‡‘é¡è¨ˆç®—æ­£ç¢ºç„¡èª¤å·®
