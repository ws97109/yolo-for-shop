---
name: æ•´åˆ YOLO æ¨¡å‹ä¸¦å¯¦ä½œå•†å“åµæ¸¬æœå‹™
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: true
conflicts_with: []
---

# Task: æ•´åˆ YOLO æ¨¡å‹ä¸¦å¯¦ä½œå•†å“åµæ¸¬æœå‹™

## Description

è¼‰å…¥å·²è¨“ç·´çš„ YOLOv8 æ¨¡å‹ï¼Œå¯¦ä½œå•†å“åµæ¸¬æœå‹™ï¼Œå°‡åµæ¸¬çµæœé€é WebSocket å‚³é€è‡³å‰ç«¯ï¼Œä¸¦åœ¨ Canvas ä¸Šç¹ªè£½åµæ¸¬æ¡†ã€‚é€™æ˜¯å•†å“è­˜åˆ¥çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€ç¢ºä¿å³æ™‚æ€§å’Œæº–ç¢ºåº¦ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼š
- è¼‰å…¥ä½æ–¼ `runs/` ç›®éŒ„çš„ YOLO æ¨¡å‹
- å¯¦ä½œå³æ™‚å•†å“åµæ¸¬æœå‹™
- éæ¿¾ä½ä¿¡å¿ƒåº¦çµæœï¼ˆ< 0.7ï¼‰
- å°‡åµæ¸¬çµæœå‚³é€è‡³å‰ç«¯
- æ ¹æ“š YOLO class_id æŸ¥è©¢å•†å“è³‡æ–™åº«
- å‰ç«¯ç¹ªè£½åµæ¸¬æ¡†å’Œæ¨™ç±¤

## Acceptance Criteria

- [ ] YOLO æ¨¡å‹æˆåŠŸè¼‰å…¥ï¼ˆé©—è­‰ `runs/detect/train/weights/best.pt` å­˜åœ¨ï¼‰
- [ ] æ¥æ”¶å½±æ ¼å¾Œèƒ½å³æ™‚åµæ¸¬å•†å“
- [ ] åµæ¸¬å»¶é² < 1 ç§’
- [ ] ä¿¡å¿ƒåº¦ < 0.7 çš„çµæœè¢«éæ¿¾
- [ ] åµæ¸¬åˆ°å…ƒç¿ èŒ¶æˆ–åˆ†è§£èŒ¶æ™‚æ­£ç¢ºè­˜åˆ¥
- [ ] å‰ç«¯ Canvas é¡¯ç¤ºç¶ è‰²åµæ¸¬æ¡†å’Œå•†å“åç¨±
- [ ] åµæ¸¬çµæœåŒ…å«å•†å“è³‡è¨Šï¼ˆåç¨±ã€åƒ¹æ ¼ã€åº§æ¨™ï¼‰
- [ ] å•†å“è³‡è¨Šå¾ MongoDB Products Collection æŸ¥è©¢

## Technical Details

### YOLO æœå‹™æ¨¡çµ„ï¼ˆyolo_service.pyï¼‰

```python
from ultralytics import YOLO
import cv2
import numpy as np
from pathlib import Path
from typing import List, Dict, Optional

from backend.config import YOLO_MODEL_PATH, CONFIDENCE_THRESHOLD, BASE_DIR
from backend.database import Database

class YOLOService:
    """YOLO å•†å“åµæ¸¬æœå‹™"""

    def __init__(self):
        self.model = None
        self.product_cache = {}  # yolo_class_id -> product_info
        self.load_model()
        self.load_products()

    def load_model(self):
        """è¼‰å…¥ YOLO æ¨¡å‹"""
        try:
            model_path = YOLO_MODEL_PATH

            if not model_path.exists():
                raise FileNotFoundError(f"YOLO æ¨¡å‹ä¸å­˜åœ¨: {model_path}")

            self.model = YOLO(str(model_path))
            print(f"âœ… YOLO æ¨¡å‹è¼‰å…¥æˆåŠŸ: {model_path}")

            # é¡¯ç¤ºæ¨¡å‹è³‡è¨Š
            print(f"   é¡åˆ¥æ•¸é‡: {len(self.model.names)}")
            print(f"   é¡åˆ¥åç¨±: {self.model.names}")

        except Exception as e:
            print(f"âŒ YOLO æ¨¡å‹è¼‰å…¥å¤±æ•—: {e}")
            raise

    def load_products(self):
        """å¾è³‡æ–™åº«è¼‰å…¥å•†å“è³‡è¨Š"""
        try:
            db = Database.get_db()
            products = db.products.find({})

            for product in products:
                yolo_class_id = product.get('yolo_class_id')
                self.product_cache[yolo_class_id] = {
                    'id': str(product['_id']),
                    'name': product['name'],
                    'price': product['price'],
                    'yolo_class_name': product.get('yolo_class_name', '')
                }

            print(f"âœ… è¼‰å…¥ {len(self.product_cache)} å€‹å•†å“è³‡è¨Š")

        except Exception as e:
            print(f"âŒ è¼‰å…¥å•†å“è³‡è¨Šå¤±æ•—: {e}")
            self.product_cache = {}

    def detect(self, frame: np.ndarray) -> List[Dict]:
        """
        åµæ¸¬å½±åƒä¸­çš„å•†å“

        Args:
            frame: OpenCV å½±åƒ (BGR format)

        Returns:
            åµæ¸¬çµæœåˆ—è¡¨ï¼Œæ¯å€‹çµæœåŒ…å«:
            {
                'class_id': int,
                'class_name': str,
                'confidence': float,
                'bbox': [x1, y1, x2, y2],
                'product': {id, name, price} or None
            }
        """
        if self.model is None:
            return []

        try:
            # YOLO æ¨è«–
            results = self.model(frame, verbose=False)

            detections = []

            for result in results:
                boxes = result.boxes

                for box in boxes:
                    # å–å¾—è³‡è¨Š
                    class_id = int(box.cls[0])
                    confidence = float(box.conf[0])
                    x1, y1, x2, y2 = box.xyxy[0].tolist()

                    # éæ¿¾ä½ä¿¡å¿ƒåº¦
                    if confidence < CONFIDENCE_THRESHOLD:
                        continue

                    # å–å¾—é¡åˆ¥åç¨±
                    class_name = self.model.names.get(class_id, f"class_{class_id}")

                    # æŸ¥è©¢å•†å“è³‡è¨Š
                    product = self.product_cache.get(class_id)

                    detection = {
                        'class_id': class_id,
                        'class_name': class_name,
                        'confidence': confidence,
                        'bbox': [int(x1), int(y1), int(x2), int(y2)],
                        'product': product
                    }

                    detections.append(detection)

            return detections

        except Exception as e:
            print(f"âŒ YOLO åµæ¸¬éŒ¯èª¤: {e}")
            return []

    def get_product_by_class_id(self, class_id: int) -> Optional[Dict]:
        """æ ¹æ“š YOLO class_id æŸ¥è©¢å•†å“"""
        return self.product_cache.get(class_id)

# å…¨åŸŸå–®ä¾‹
yolo_service = YOLOService()
```

### æ•´åˆè‡³ main.py

ä¿®æ”¹ `backend/main.py` çš„ `handle_frame` å‡½å¼ï¼š

```python
from backend.services.yolo_service import yolo_service

async def handle_frame(session_id: str, data: dict):
    """è™•ç†å½±åƒå½±æ ¼"""
    try:
        # è§£ç¢¼ Base64 å½±åƒ
        frame_data = data.get("frame")
        if not frame_data:
            return

        if "," in frame_data:
            frame_data = frame_data.split(",")[1]

        image_bytes = base64.b64decode(frame_data)
        nparr = np.frombuffer(image_bytes, np.uint8)
        frame = cv2.imdecode(nparr, cv2.IMREAD_COLOR)

        if frame is None:
            return

        # YOLO å•†å“åµæ¸¬
        detections = yolo_service.detect(frame)

        if detections:
            # ç™¼é€åµæ¸¬çµæœè‡³å‰ç«¯
            await manager.send_message(session_id, {
                "type": "detections",
                "detections": detections,
                "timestamp": datetime.utcnow().isoformat()
            })

            # å¦‚æœåµæ¸¬åˆ°å•†å“ï¼Œè‡ªå‹•åŠ å…¥è³¼ç‰©è»Š
            for detection in detections:
                product = detection.get('product')
                if product:
                    await handle_product_detected(session_id, product, detection)

    except Exception as e:
        print(f"âŒ è™•ç†å½±æ ¼éŒ¯èª¤: {e}")

async def handle_product_detected(session_id: str, product: dict, detection: dict):
    """è™•ç†åµæ¸¬åˆ°çš„å•†å“"""
    try:
        session = manager.get_session(session_id)

        if not session or not session.get('user_id'):
            # ä½¿ç”¨è€…æœªç™»å…¥ï¼Œä¸åŠ å…¥è³¼ç‰©è»Š
            return

        # ç™¼é€å•†å“åµæ¸¬äº‹ä»¶
        await manager.send_message(session_id, {
            "type": "product_detected",
            "product": product,
            "confidence": detection['confidence'],
            "bbox": detection['bbox']
        })

        print(f"ğŸ“¦ åµæ¸¬åˆ°å•†å“: {product['name']} (ä¿¡å¿ƒåº¦: {detection['confidence']:.2f})")

    except Exception as e:
        print(f"âŒ è™•ç†å•†å“åµæ¸¬éŒ¯èª¤: {e}")
```

### å‰ç«¯é¡¯ç¤ºåµæ¸¬æ¡†

ä¿®æ”¹ `frontend/static/js/main.js`ï¼š

```javascript
// ç›£è½åµæ¸¬çµæœ
wsClient.on('detections', (data) => {
    // æ¸…é™¤èˆŠçš„åµæ¸¬æ¡†
    cameraManager.clearCanvas();

    // ç¹ªè£½æ¯å€‹åµæ¸¬æ¡†
    data.detections.forEach(detection => {
        const [x1, y1, x2, y2] = detection.bbox;
        const width = x2 - x1;
        const height = y2 - y1;

        let label = detection.class_name;
        if (detection.product) {
            label = `${detection.product.name} (${(detection.confidence * 100).toFixed(0)}%)`;
        }

        cameraManager.drawBox(x1, y1, width, height, label, '#00ff00');
    });
});

wsClient.on('product_detected', (data) => {
    console.log('ğŸ“¦ å•†å“å·²åŠ å…¥è³¼ç‰©è»Š:', data.product);
    // è³¼ç‰©è»Šæœƒåœ¨ Task 006 å¯¦ä½œ
});
```

ä¿®æ”¹ `frontend/static/js/camera.js` åŠ å…¥æ¸…é™¤ Canvas æ–¹æ³•ï¼š

```javascript
class CameraManager {
    // ... å…¶ä»–æ–¹æ³• ...

    clearCanvas() {
        // é‡æ–°ç¹ªè£½åŸå§‹å½±æ ¼ï¼ˆæ¸…é™¤åµæ¸¬æ¡†ï¼‰
        if (this.isRunning && this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
            this.ctx.drawImage(
                this.video,
                0, 0,
                this.canvas.width,
                this.canvas.height
            );
        }
    }

    drawBox(x, y, width, height, label, color = '#00ff00') {
        // ç¹ªè£½åµæ¸¬æ¡†
        this.ctx.strokeStyle = color;
        this.ctx.lineWidth = 3;
        this.ctx.strokeRect(x, y, width, height);

        // ç¹ªè£½æ¨™ç±¤èƒŒæ™¯
        this.ctx.font = 'bold 16px Arial';
        const textWidth = this.ctx.measureText(label).width;
        this.ctx.fillStyle = color;
        this.ctx.fillRect(x, y - 25, textWidth + 10, 25);

        // ç¹ªè£½æ¨™ç±¤æ–‡å­—
        this.ctx.fillStyle = '#000';
        this.ctx.fillText(label, x + 5, y - 7);
    }
}
```

### è³‡æ–™æ¨¡å‹ï¼ˆmodels/product.pyï¼‰

```python
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime

class Product(BaseModel):
    """å•†å“è³‡æ–™æ¨¡å‹"""
    id: Optional[str] = Field(None, alias='_id')
    name: str
    price: float
    yolo_class_id: int
    yolo_class_name: str
    image: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.utcnow)

    class Config:
        populate_by_name = True
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

### æ¸¬è©¦è…³æœ¬

```python
# scripts/test_yolo.py
import sys
from pathlib import Path
import cv2

sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.services.yolo_service import yolo_service

def test_yolo():
    """æ¸¬è©¦ YOLO åµæ¸¬"""
    print("é–‹å§‹æ¸¬è©¦ YOLO...")

    # è®€å–æ¸¬è©¦åœ–ç‰‡ï¼ˆä½¿ç”¨ dataset ä¸­çš„åœ–ç‰‡ï¼‰
    test_image_path = Path("dataset/images/train")  # èª¿æ•´ç‚ºå¯¦éš›è·¯å¾‘
    test_images = list(test_image_path.glob("*.jpg"))[:3]

    if not test_images:
        print("âŒ æ‰¾ä¸åˆ°æ¸¬è©¦åœ–ç‰‡")
        return

    for img_path in test_images:
        print(f"\næ¸¬è©¦åœ–ç‰‡: {img_path.name}")
        frame = cv2.imread(str(img_path))

        if frame is None:
            print("  âŒ ç„¡æ³•è®€å–åœ–ç‰‡")
            continue

        # åµæ¸¬
        detections = yolo_service.detect(frame)

        if detections:
            print(f"  âœ… åµæ¸¬åˆ° {len(detections)} å€‹å•†å“:")
            for det in detections:
                print(f"     - {det['product']['name'] if det['product'] else det['class_name']}")
                print(f"       ä¿¡å¿ƒåº¦: {det['confidence']:.2f}")
                print(f"       åº§æ¨™: {det['bbox']}")
        else:
            print("  âš ï¸ æœªåµæ¸¬åˆ°å•†å“")

if __name__ == "__main__":
    test_yolo()
```

## Dependencies

- [ ] Task 001 å®Œæˆï¼ˆå°ˆæ¡ˆçµæ§‹å’Œè³‡æ–™åº«ï¼‰
- [ ] Task 002 å®Œæˆï¼ˆFastAPI å’Œ WebSocketï¼‰
- [ ] YOLO æ¨¡å‹æª”æ¡ˆå­˜åœ¨æ–¼ `runs/detect/train/weights/best.pt`
- [ ] Products Collection å·²åˆå§‹åŒ–å•†å“è³‡æ–™

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 4-6 å°æ™‚
- **Parallel**: trueï¼ˆå¯èˆ‡ Task 005 åŒæ™‚é–‹ç™¼ï¼‰

**æ™‚é–“åˆ†é…**ï¼š
- YOLOService é¡åˆ¥å¯¦ä½œï¼š2 å°æ™‚
- æ•´åˆè‡³ main.pyï¼š1 å°æ™‚
- å‰ç«¯åµæ¸¬æ¡†ç¹ªè£½ï¼š1 å°æ™‚
- æ¸¬è©¦å’Œèª¿æ ¡ï¼š1-2 å°æ™‚

## Definition of Done

- [ ] åŸ·è¡Œ `python scripts/test_yolo.py` æˆåŠŸåµæ¸¬æ¸¬è©¦åœ–ç‰‡
- [ ] å•Ÿå‹•ç³»çµ±å¾Œï¼Œå°‡èŒ¶è‘‰å•†å“å±•ç¤ºçµ¦é¡é ­
- [ ] Canvas ä¸Šå‡ºç¾ç¶ è‰²åµæ¸¬æ¡†å’Œå•†å“åç¨±
- [ ] Console é¡¯ç¤ºã€ŒğŸ“¦ åµæ¸¬åˆ°å•†å“: å…ƒç¿ èŒ¶/åˆ†è§£èŒ¶ã€
- [ ] åµæ¸¬å»¶é² < 1 ç§’ï¼ˆå¾é¡¯ç¤ºå•†å“åˆ°å‡ºç¾åµæ¸¬æ¡†ï¼‰
- [ ] ä¿¡å¿ƒåº¦ä½çš„èª¤åµæ¸¬ä¸æœƒé¡¯ç¤º
- [ ] åµæ¸¬æ¡†ä½ç½®å’Œå¤§å°æº–ç¢º
- [ ] å•†å“åƒ¹æ ¼æ­£ç¢ºå¾è³‡æ–™åº«æŸ¥è©¢
- [ ] é•·æ™‚é–“é‹è¡Œï¼ˆ10 åˆ†é˜ï¼‰ç„¡è¨˜æ†¶é«”æ´©æ¼
- [ ] GPU å¯ç”¨æ™‚è‡ªå‹•å•Ÿç”¨åŠ é€Ÿï¼ˆæª¢æŸ¥ YOLO è¼¸å‡ºï¼‰
