---
name: å¯¦ä½œè³¼ç‰©è»Šé‚è¼¯èˆ‡å‰ç«¯ UI
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003, 004, 005]
parallel: false
conflicts_with: []
---

# Task: å¯¦ä½œè³¼ç‰©è»Šé‚è¼¯èˆ‡å‰ç«¯ UI

## Description

å¯¦ä½œè³¼ç‰©è»Šå¾Œç«¯é‚è¼¯å’Œå‰ç«¯ UIï¼ŒåŒ…æ‹¬å•†å“åŠ å…¥ã€æ•¸é‡ç´¯åŠ ã€å•†å“ç§»é™¤ã€ç¸½åƒ¹è¨ˆç®—ï¼Œä»¥åŠè³¼ç‰©è»Šæ¸…å–®çš„å³æ™‚é¡¯ç¤ºæ›´æ–°ã€‚é€™æ˜¯è³¼ç‰©æµç¨‹çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼š
- å¾Œç«¯è³¼ç‰©è»Šæœå‹™ï¼ˆåŠ å…¥ã€ç§»é™¤ã€è¨ˆç®—ï¼‰
- å‰ç«¯è³¼ç‰©è»Š UIï¼ˆå•†å“æ¸…å–®ã€ç¸½åƒ¹é¡¯ç¤ºï¼‰
- è‡ªå‹•å•†å“å»é‡å’Œæ•¸é‡ç´¯åŠ 
- å³æ™‚æ›´æ–°è³¼ç‰©è»Šç‹€æ…‹
- æ”¯æ´æ‰‹å‹•ç§»é™¤å•†å“

## Acceptance Criteria

- [ ] åµæ¸¬åˆ°å•†å“æ™‚è‡ªå‹•åŠ å…¥è³¼ç‰©è»Š
- [ ] åŒä¸€å•†å“å¤šæ¬¡æƒæï¼Œæ•¸é‡è‡ªå‹• +1
- [ ] å³å´é¢æ¿å³æ™‚é¡¯ç¤ºå•†å“æ¸…å–®
- [ ] æ¯é …å•†å“é¡¯ç¤ºï¼šåç¨±ã€å–®åƒ¹ã€æ•¸é‡ã€å°è¨ˆ
- [ ] å³ä¸‹è§’é¡¯ç¤ºç¸½æ•¸é‡å’Œç¸½é‡‘é¡
- [ ] é»æ“Šã€Œç§»é™¤ã€æŒ‰éˆ•æˆåŠŸç§»é™¤å•†å“
- [ ] è³¼ç‰©è»Šç‚ºç©ºæ™‚é¡¯ç¤ºã€Œè³¼ç‰©è»Šæ˜¯ç©ºçš„ã€
- [ ] è³¼ç‰©è»Šæ›´æ–°æµæš¢ç„¡å»¶é²
- [ ] ç¸½åƒ¹è¨ˆç®—æ­£ç¢º

## Technical Details

### è³¼ç‰©è»Šæœå‹™ï¼ˆcart_service.pyï¼‰

```python
from typing import List, Dict, Optional
from datetime import datetime

class CartService:
    """è³¼ç‰©è»Šæœå‹™"""

    def __init__(self):
        # ä½¿ç”¨ session_id ç®¡ç†æ¯å€‹é€£ç·šçš„è³¼ç‰©è»Š
        self.carts: Dict[str, List[Dict]] = {}

    def get_cart(self, session_id: str) -> List[Dict]:
        """å–å¾—è³¼ç‰©è»Š"""
        if session_id not in self.carts:
            self.carts[session_id] = []
        return self.carts[session_id]

    def add_item(self, session_id: str, product: Dict) -> Dict:
        """
        åŠ å…¥å•†å“åˆ°è³¼ç‰©è»Š

        Args:
            session_id: Session ID
            product: å•†å“è³‡è¨Š {id, name, price, ...}

        Returns:
            æ›´æ–°å¾Œçš„è³¼ç‰©è»Šç‹€æ…‹
        """
        cart = self.get_cart(session_id)
        product_id = product['id']

        # æª¢æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
        existing_item = None
        for item in cart:
            if item['product_id'] == product_id:
                existing_item = item
                break

        if existing_item:
            # å•†å“å·²å­˜åœ¨ï¼Œæ•¸é‡ +1
            existing_item['quantity'] += 1
            existing_item['subtotal'] = existing_item['quantity'] * existing_item['unit_price']
            print(f"ğŸ›’ å•†å“æ•¸é‡ +1: {existing_item['name']} (x{existing_item['quantity']})")
        else:
            # æ–°å•†å“
            new_item = {
                'product_id': product_id,
                'name': product['name'],
                'unit_price': product['price'],
                'quantity': 1,
                'subtotal': product['price']
            }
            cart.append(new_item)
            print(f"ğŸ›’ åŠ å…¥è³¼ç‰©è»Š: {new_item['name']}")

        return self.get_cart_summary(session_id)

    def remove_item(self, session_id: str, index: int) -> Dict:
        """
        ç§»é™¤è³¼ç‰©è»Šä¸­çš„å•†å“

        Args:
            session_id: Session ID
            index: å•†å“ç´¢å¼•

        Returns:
            æ›´æ–°å¾Œçš„è³¼ç‰©è»Šç‹€æ…‹
        """
        cart = self.get_cart(session_id)

        if 0 <= index < len(cart):
            removed_item = cart.pop(index)
            print(f"ğŸ—‘ï¸ ç§»é™¤å•†å“: {removed_item['name']}")
        else:
            print(f"âš ï¸ ç„¡æ•ˆçš„å•†å“ç´¢å¼•: {index}")

        return self.get_cart_summary(session_id)

    def clear_cart(self, session_id: str):
        """æ¸…ç©ºè³¼ç‰©è»Š"""
        if session_id in self.carts:
            del self.carts[session_id]
            print(f"ğŸ§¹ è³¼ç‰©è»Šå·²æ¸…ç©º: {session_id}")

    def get_cart_summary(self, session_id: str) -> Dict:
        """
        å–å¾—è³¼ç‰©è»Šæ‘˜è¦

        Returns:
            {
                'items': [...],
                'total_quantity': int,
                'total_amount': float
            }
        """
        cart = self.get_cart(session_id)

        total_quantity = sum(item['quantity'] for item in cart)
        total_amount = sum(item['subtotal'] for item in cart)

        return {
            'items': cart,
            'total_quantity': total_quantity,
            'total_amount': total_amount
        }

    def validate_cart(self, session_id: str) -> bool:
        """é©—è­‰è³¼ç‰©è»Šæ˜¯å¦æœ‰æ•ˆï¼ˆè‡³å°‘ä¸€ä»¶å•†å“ï¼‰"""
        cart = self.get_cart(session_id)
        return len(cart) > 0

# å…¨åŸŸå–®ä¾‹
cart_service = CartService()
```

### æ•´åˆè‡³ main.py

```python
from backend.services.cart_service import cart_service

async def handle_product_detected(session_id: str, product: dict, detection: dict):
    """è™•ç†åµæ¸¬åˆ°çš„å•†å“"""
    try:
        session = manager.get_session(session_id)

        if not session or not session.get('user_id'):
            return

        # åŠ å…¥è³¼ç‰©è»Š
        cart_summary = cart_service.add_item(session_id, product)

        # ç™¼é€è³¼ç‰©è»Šæ›´æ–°
        await manager.send_message(session_id, {
            "type": "cart_updated",
            "cart": cart_summary
        })

        # ä¹Ÿç™¼é€å–®æ¬¡å•†å“åµæ¸¬äº‹ä»¶ï¼ˆç”¨æ–¼è¦–è¦ºå›é¥‹ï¼‰
        await manager.send_message(session_id, {
            "type": "product_added",
            "product": product,
            "confidence": detection['confidence']
        })

        print(f"ğŸ“¦ å•†å“åŠ å…¥è³¼ç‰©è»Š: {product['name']}")

    except Exception as e:
        print(f"âŒ è™•ç†å•†å“åµæ¸¬éŒ¯èª¤: {e}")

async def handle_cart_remove(session_id: str, data: dict):
    """è™•ç†ç§»é™¤è³¼ç‰©è»Šå•†å“"""
    try:
        item_index = data.get("index")

        if item_index is None:
            print("âš ï¸ ç¼ºå°‘å•†å“ç´¢å¼•")
            return

        # ç§»é™¤å•†å“
        cart_summary = cart_service.remove_item(session_id, item_index)

        # ç™¼é€æ›´æ–°
        await manager.send_message(session_id, {
            "type": "cart_updated",
            "cart": cart_summary
        })

    except Exception as e:
        print(f"âŒ ç§»é™¤è³¼ç‰©è»Šå•†å“éŒ¯èª¤: {e}")

# WebSocket ç«¯é»ä¸­åŠ å…¥è³¼ç‰©è»Šç§»é™¤è™•ç†
@app.websocket("/ws/{session_id}")
async def websocket_endpoint(websocket: WebSocket, session_id: str):
    await manager.connect(websocket, session_id)

    try:
        while True:
            data = await websocket.receive_json()
            message_type = data.get("type")

            if message_type == "frame":
                await handle_frame(session_id, data)

            elif message_type == "cart_remove":
                await handle_cart_remove(session_id, data)

            elif message_type == "ping":
                await manager.send_message(session_id, {"type": "pong"})

    except WebSocketDisconnect:
        manager.disconnect(session_id)
        cart_service.clear_cart(session_id)
    except Exception as e:
        print(f"âŒ WebSocket éŒ¯èª¤: {e}")
        manager.disconnect(session_id)
```

### å‰ç«¯è³¼ç‰©è»Š UIï¼ˆcart.jsï¼‰

```javascript
class Cart {
    constructor() {
        this.items = [];
        this.totalQuantity = 0;
        this.totalAmount = 0;
    }

    update(cartData) {
        this.items = cartData.items || [];
        this.totalQuantity = cartData.total_quantity || 0;
        this.totalAmount = cartData.total_amount || 0;

        this.render();
    }

    render() {
        const cartItemsEl = document.getElementById('cart-items');
        const totalQuantityEl = document.getElementById('total-quantity');
        const totalAmountEl = document.getElementById('total-amount');
        const checkoutBtn = document.getElementById('checkout-btn');

        // æ›´æ–°å•†å“æ¸…å–®
        if (this.items.length === 0) {
            cartItemsEl.innerHTML = `
                <div class="empty-cart">
                    ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„
                </div>
            `;
            checkoutBtn.disabled = true;
        } else {
            cartItemsEl.innerHTML = this.items.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-details">
                            NT$ ${item.unit_price} Ã— ${item.quantity} = NT$ ${item.subtotal}
                        </div>
                    </div>
                    <button class="cart-item-remove" onclick="cart.removeItem(${index})">
                        ç§»é™¤
                    </button>
                </div>
            `).join('');

            checkoutBtn.disabled = false;
        }

        // æ›´æ–°ç¸½è¨ˆ
        totalQuantityEl.textContent = this.totalQuantity;
        totalAmountEl.textContent = `NT$ ${this.totalAmount}`;
    }

    removeItem(index) {
        console.log(`ğŸ—‘ï¸ ç§»é™¤å•†å“ç´¢å¼•: ${index}`);

        // ç™¼é€ç§»é™¤è«‹æ±‚
        wsClient.send({
            type: 'cart_remove',
            index: index
        });
    }

    clear() {
        this.items = [];
        this.totalQuantity = 0;
        this.totalAmount = 0;
        this.render();
    }

    checkout() {
        if (this.items.length === 0) {
            alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•çµå¸³');
            return;
        }

        // ç¢ºèªçµå¸³
        const confirmed = confirm(
            `ç¢ºèªçµå¸³ï¼Ÿ\n\n` +
            `å•†å“æ•¸é‡ï¼š${this.totalQuantity}\n` +
            `ç¸½é‡‘é¡ï¼šNT$ ${this.totalAmount}`
        );

        if (!confirmed) return;

        // ç™¼é€çµå¸³è«‹æ±‚ï¼ˆåœ¨ Task 007 å¯¦ä½œï¼‰
        fetch('/api/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: wsClient.sessionId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('çµå¸³æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„è³¼è²·');
                this.clear();
            } else {
                alert('çµå¸³å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(err => {
            console.error('âŒ çµå¸³éŒ¯èª¤:', err);
            alert('çµå¸³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        });
    }
}

// å…¨åŸŸå¯¦ä¾‹
const cart = new Cart();
```

### æ›´æ–° main.js

```javascript
// ç›£è½è³¼ç‰©è»Šæ›´æ–°
wsClient.on('cart_updated', (data) => {
    console.log('ğŸ›’ è³¼ç‰©è»Šæ›´æ–°:', data.cart);
    cart.update(data.cart);
});

wsClient.on('product_added', (data) => {
    console.log('ğŸ“¦ å•†å“å·²åŠ å…¥:', data.product.name);
    // å¯åŠ å…¥è¦–è¦ºå›é¥‹ï¼Œä¾‹å¦‚å½ˆå‡ºæç¤º
    showToast(`å·²åŠ å…¥ï¼š${data.product.name}`);
});

// çµå¸³æŒ‰éˆ•
document.getElementById('checkout-btn').addEventListener('click', () => {
    cart.checkout();
});

// ç°¡å–®çš„ Toast æç¤º
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('show');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}
```

### Toast æ¨£å¼ï¼ˆåŠ å…¥ style.cssï¼‰

```css
/* Toast æç¤º */
.toast {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: #333;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}
```

### æ¸¬è©¦å•†å“åŠ å…¥æµç¨‹

```python
# scripts/test_cart.py
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.services.cart_service import cart_service

def test_cart():
    """æ¸¬è©¦è³¼ç‰©è»ŠåŠŸèƒ½"""
    print("é–‹å§‹æ¸¬è©¦è³¼ç‰©è»Š...")

    session_id = "test_session"

    # æ¸¬è©¦å•†å“
    product1 = {'id': '1', 'name': 'å…ƒç¿ èŒ¶', 'price': 150.0}
    product2 = {'id': '2', 'name': 'åˆ†è§£èŒ¶', 'price': 200.0}

    # åŠ å…¥å•†å“
    print("\n1. åŠ å…¥å•†å“")
    result = cart_service.add_item(session_id, product1)
    print(f"   è³¼ç‰©è»Š: {result}")

    # å†æ¬¡åŠ å…¥ç›¸åŒå•†å“
    print("\n2. å†æ¬¡åŠ å…¥ç›¸åŒå•†å“")
    result = cart_service.add_item(session_id, product1)
    print(f"   è³¼ç‰©è»Š: {result}")

    # åŠ å…¥ä¸åŒå•†å“
    print("\n3. åŠ å…¥ä¸åŒå•†å“")
    result = cart_service.add_item(session_id, product2)
    print(f"   è³¼ç‰©è»Š: {result}")

    # ç§»é™¤å•†å“
    print("\n4. ç§»é™¤ç´¢å¼• 0 çš„å•†å“")
    result = cart_service.remove_item(session_id, 0)
    print(f"   è³¼ç‰©è»Š: {result}")

    # æ¸…ç©ºè³¼ç‰©è»Š
    print("\n5. æ¸…ç©ºè³¼ç‰©è»Š")
    cart_service.clear_cart(session_id)
    result = cart_service.get_cart_summary(session_id)
    print(f"   è³¼ç‰©è»Š: {result}")

    print("\nâœ… è³¼ç‰©è»Šæ¸¬è©¦å®Œæˆ")

if __name__ == "__main__":
    test_cart()
```

## Dependencies

- [ ] Task 002 å®Œæˆï¼ˆFastAPI å’Œ WebSocketï¼‰
- [ ] Task 003 å®Œæˆï¼ˆå‰ç«¯é é¢ï¼‰
- [ ] Task 004 å®Œæˆï¼ˆYOLO å•†å“åµæ¸¬ï¼‰
- [ ] Task 005 å®Œæˆï¼ˆäººè‡‰è­˜åˆ¥ç™»å…¥ï¼‰

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 3-4 å°æ™‚
- **Parallel**: falseï¼ˆä¾è³´å¤šå€‹å‰ç½®ä»»å‹™ï¼‰

**æ™‚é–“åˆ†é…**ï¼š
- CartService å¯¦ä½œï¼š1.5 å°æ™‚
- å‰ç«¯ cart.js å¯¦ä½œï¼š1 å°æ™‚
- æ•´åˆæ¸¬è©¦ï¼š1-1.5 å°æ™‚

## Definition of Done

- [ ] åŸ·è¡Œ `python scripts/test_cart.py` æ¸¬è©¦é€šé
- [ ] å•Ÿå‹•ç³»çµ±å¾Œï¼Œç™»å…¥ä¸¦æƒæå•†å“
- [ ] å•†å“è‡ªå‹•åŠ å…¥å³å´è³¼ç‰©è»Šæ¸…å–®
- [ ] åŒä¸€å•†å“æƒæå¤šæ¬¡ï¼Œæ•¸é‡æ­£ç¢ºç´¯åŠ 
- [ ] æ¯é …å•†å“é¡¯ç¤ºåç¨±ã€å–®åƒ¹ã€æ•¸é‡ã€å°è¨ˆ
- [ ] ç¸½æ•¸é‡å’Œç¸½é‡‘é¡è¨ˆç®—æ­£ç¢º
- [ ] é»æ“Šã€Œç§»é™¤ã€æŒ‰éˆ•ï¼Œå•†å“å¾æ¸…å–®æ¶ˆå¤±
- [ ] è³¼ç‰©è»Šç‚ºç©ºæ™‚é¡¯ç¤ºã€Œè³¼ç‰©è»Šæ˜¯ç©ºçš„ã€
- [ ] å•†å“åŠ å…¥æ™‚é¡¯ç¤º Toast æç¤º
- [ ] è³¼ç‰©è»Šæ›´æ–°æµæš¢ç„¡å»¶é²ï¼ˆ< 100msï¼‰
- [ ] Console æ­£ç¢ºé¡¯ç¤ºè³¼ç‰©è»Šæ“ä½œæ—¥èªŒ
- [ ] æœ‰å•†å“æ™‚ã€Œå®Œæˆçµå¸³ã€æŒ‰éˆ•å•Ÿç”¨ï¼Œç„¡å•†å“æ™‚ç¦ç”¨
