---
name: å¯¦ä½œäººè‡‰è­˜åˆ¥æœå‹™ï¼ˆè¨»å†Šã€æ¯”å°ã€ç™»å…¥ï¼‰
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: true
conflicts_with: []
---

# Task: å¯¦ä½œäººè‡‰è­˜åˆ¥æœå‹™ï¼ˆè¨»å†Šã€æ¯”å°ã€ç™»å…¥ï¼‰

## Description

å¯¦ä½œäººè‡‰è­˜åˆ¥æœå‹™ï¼ŒåŒ…æ‹¬äººè‡‰åµæ¸¬ã€ç‰¹å¾µæå–ã€æ–°ä½¿ç”¨è€…è¨»å†Šã€å›è¨ªä½¿ç”¨è€…æ¯”å°å’Œè‡ªå‹•ç™»å…¥åŠŸèƒ½ã€‚é€™æ˜¯ä½¿ç”¨è€…èº«ä»½é©—è­‰çš„æ ¸å¿ƒï¼Œéœ€ç¢ºä¿æº–ç¢ºåº¦å’Œå®‰å…¨æ€§ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼š
- ä½¿ç”¨ face_recognition å¥—ä»¶é€²è¡Œäººè‡‰è­˜åˆ¥
- åµæ¸¬å½±æ ¼ä¸­çš„äººè‡‰ä¸¦æå– 128-d ç‰¹å¾µå‘é‡
- æ–°ä½¿ç”¨è€…è¨»å†Šï¼ˆè¼¸å…¥å§“åã€é›»è©±ï¼Œå„²å­˜äººè‡‰ï¼‰
- å›è¨ªä½¿ç”¨è€…è‡ªå‹•è­˜åˆ¥ä¸¦ç™»å…¥
- äººè‡‰åœ–ç‰‡å„²å­˜è‡³ `data/faces/` ç›®éŒ„
- å‰ç«¯é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š

## Acceptance Criteria

- [ ] æˆåŠŸåµæ¸¬å½±æ ¼ä¸­çš„äººè‡‰
- [ ] äººè‡‰è­˜åˆ¥å›æ‡‰æ™‚é–“ < 2 ç§’
- [ ] æ–°ä½¿ç”¨è€…è¨»å†Šæµç¨‹å®Œæ•´ï¼ˆå½ˆå‡ºè¡¨å–®ã€å„²å­˜è³‡æ–™ï¼‰
- [ ] å›è¨ªä½¿ç”¨è€…è‡ªå‹•è­˜åˆ¥ä¸¦é¡¯ç¤ºã€Œæ­¡è¿å›ä¾†ï¼ŒXXXã€
- [ ] äººè‡‰ç‰¹å¾µå‘é‡æ­£ç¢ºå„²å­˜è‡³ MongoDB
- [ ] äººè‡‰åœ–ç‰‡å„²å­˜è‡³ `data/faces/{user_id}.jpg`
- [ ] è­˜åˆ¥æº–ç¢ºç‡ > 90%ï¼ˆç›¸åŒäººè‡‰æ­£ç¢ºè­˜åˆ¥ï¼‰
- [ ] ä¸åŒäººè‡‰ä¸æœƒèª¤è­˜åˆ¥
- [ ] å‰ç«¯å·¦å´é¢æ¿æ­£ç¢ºé¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š

## Technical Details

### äººè‡‰è­˜åˆ¥æœå‹™ï¼ˆface_service.pyï¼‰

```python
import face_recognition
import cv2
import numpy as np
from pathlib import Path
from typing import Optional, Dict, List, Tuple
from datetime import datetime
from bson import ObjectId

from backend.config import FACE_IMAGES_DIR, FACE_MATCH_TOLERANCE, BASE_DIR
from backend.database import Database

class FaceService:
    """äººè‡‰è­˜åˆ¥æœå‹™"""

    def __init__(self):
        self.known_faces = {}  # user_id -> face_encoding
        self.known_users = {}  # user_id -> user_info
        self.load_known_faces()

        # ç¢ºä¿äººè‡‰åœ–ç‰‡ç›®éŒ„å­˜åœ¨
        FACE_IMAGES_DIR.mkdir(parents=True, exist_ok=True)

    def load_known_faces(self):
        """å¾è³‡æ–™åº«è¼‰å…¥å·²çŸ¥äººè‡‰"""
        try:
            db = Database.get_db()
            users = db.users.find({})

            for user in users:
                user_id = str(user['_id'])
                face_encoding = user.get('face_encoding')

                if face_encoding:
                    self.known_faces[user_id] = np.array(face_encoding)
                    self.known_users[user_id] = {
                        'id': user_id,
                        'name': user['name'],
                        'phone': user['phone']
                    }

            print(f"âœ… è¼‰å…¥ {len(self.known_faces)} å€‹å·²çŸ¥äººè‡‰")

        except Exception as e:
            print(f"âŒ è¼‰å…¥äººè‡‰è³‡æ–™å¤±æ•—: {e}")
            self.known_faces = {}
            self.known_users = {}

    def detect_faces(self, frame: np.ndarray) -> List[Tuple[np.ndarray, Tuple[int, int, int, int]]]:
        """
        åµæ¸¬å½±åƒä¸­çš„äººè‡‰

        Args:
            frame: OpenCV å½±åƒ (BGR format)

        Returns:
            [(face_encoding, (top, right, bottom, left)), ...]
        """
        try:
            # è½‰æ›ç‚º RGBï¼ˆface_recognition éœ€è¦ï¼‰
            rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

            # åµæ¸¬äººè‡‰ä½ç½®
            face_locations = face_recognition.face_locations(rgb_frame, model='hog')

            if not face_locations:
                return []

            # æå–äººè‡‰ç‰¹å¾µ
            face_encodings = face_recognition.face_encodings(rgb_frame, face_locations)

            results = []
            for encoding, location in zip(face_encodings, face_locations):
                results.append((encoding, location))

            return results

        except Exception as e:
            print(f"âŒ äººè‡‰åµæ¸¬éŒ¯èª¤: {e}")
            return []

    def match_face(self, face_encoding: np.ndarray) -> Optional[Dict]:
        """
        æ¯”å°äººè‡‰ï¼Œæ‰¾å‡ºå·²çŸ¥ä½¿ç”¨è€…

        Args:
            face_encoding: 128-d äººè‡‰ç‰¹å¾µå‘é‡

        Returns:
            ä½¿ç”¨è€…è³‡è¨Š {id, name, phone, distance} æˆ– None
        """
        if not self.known_faces:
            return None

        try:
            # è¨ˆç®—èˆ‡æ‰€æœ‰å·²çŸ¥äººè‡‰çš„è·é›¢
            known_ids = list(self.known_faces.keys())
            known_encodings = [self.known_faces[uid] for uid in known_ids]

            face_distances = face_recognition.face_distance(known_encodings, face_encoding)

            # æ‰¾å‡ºæœ€ç›¸ä¼¼çš„
            best_match_index = np.argmin(face_distances)
            best_distance = face_distances[best_match_index]

            # æª¢æŸ¥æ˜¯å¦åœ¨å®¹å¿ç¯„åœå…§
            if best_distance < FACE_MATCH_TOLERANCE:
                user_id = known_ids[best_match_index]
                user_info = self.known_users[user_id].copy()
                user_info['distance'] = float(best_distance)

                # æ›´æ–°æœ€å¾Œè¨ªå•æ™‚é–“
                self.update_last_visit(user_id)

                return user_info

            return None

        except Exception as e:
            print(f"âŒ äººè‡‰æ¯”å°éŒ¯èª¤: {e}")
            return None

    def register_user(self, name: str, phone: str, face_encoding: np.ndarray, face_image: np.ndarray) -> Dict:
        """
        è¨»å†Šæ–°ä½¿ç”¨è€…

        Args:
            name: å§“å
            phone: é›»è©±
            face_encoding: äººè‡‰ç‰¹å¾µå‘é‡
            face_image: äººè‡‰åœ–ç‰‡ (BGR format)

        Returns:
            ä½¿ç”¨è€…è³‡è¨Š {id, name, phone}
        """
        try:
            db = Database.get_db()

            # æª¢æŸ¥é›»è©±æ˜¯å¦å·²å­˜åœ¨
            existing_user = db.users.find_one({'phone': phone})
            if existing_user:
                raise ValueError(f"é›»è©±è™Ÿç¢¼ {phone} å·²è¢«è¨»å†Š")

            # å»ºç«‹ä½¿ç”¨è€…æ–‡ä»¶
            user_doc = {
                'name': name,
                'phone': phone,
                'face_encoding': face_encoding.tolist(),
                'face_image_path': '',  # ç¨å¾Œæ›´æ–°
                'created_at': datetime.utcnow(),
                'last_visit': datetime.utcnow()
            }

            result = db.users.insert_one(user_doc)
            user_id = str(result.inserted_id)

            # å„²å­˜äººè‡‰åœ–ç‰‡
            image_path = FACE_IMAGES_DIR / f"{user_id}.jpg"
            cv2.imwrite(str(image_path), face_image)

            # æ›´æ–°åœ–ç‰‡è·¯å¾‘
            db.users.update_one(
                {'_id': result.inserted_id},
                {'$set': {'face_image_path': str(image_path)}}
            )

            # åŠ å…¥è¨˜æ†¶é«”å¿«å–
            self.known_faces[user_id] = face_encoding
            self.known_users[user_id] = {
                'id': user_id,
                'name': name,
                'phone': phone
            }

            print(f"âœ… ä½¿ç”¨è€…è¨»å†ŠæˆåŠŸ: {name} ({phone})")

            return {
                'id': user_id,
                'name': name,
                'phone': phone
            }

        except Exception as e:
            print(f"âŒ ä½¿ç”¨è€…è¨»å†Šå¤±æ•—: {e}")
            raise

    def update_last_visit(self, user_id: str):
        """æ›´æ–°ä½¿ç”¨è€…æœ€å¾Œè¨ªå•æ™‚é–“"""
        try:
            db = Database.get_db()
            db.users.update_one(
                {'_id': ObjectId(user_id)},
                {'$set': {'last_visit': datetime.utcnow()}}
            )
        except Exception as e:
            print(f"âš ï¸ æ›´æ–°æœ€å¾Œè¨ªå•æ™‚é–“å¤±æ•—: {e}")

    def get_user_by_id(self, user_id: str) -> Optional[Dict]:
        """æ ¹æ“š ID å–å¾—ä½¿ç”¨è€…è³‡è¨Š"""
        try:
            db = Database.get_db()
            user = db.users.find_one({'_id': ObjectId(user_id)})

            if user:
                return {
                    'id': str(user['_id']),
                    'name': user['name'],
                    'phone': user['phone'],
                    'created_at': user['created_at'].isoformat() if user.get('created_at') else None
                }

            return None

        except Exception as e:
            print(f"âŒ å–å¾—ä½¿ç”¨è€…å¤±æ•—: {e}")
            return None

# å…¨åŸŸå–®ä¾‹
face_service = FaceService()
```

### æ•´åˆè‡³ main.py

```python
from backend.services.face_service import face_service

# å…¨åŸŸè®Šæ•¸ï¼šè¨˜éŒ„æœ€å¾Œåµæ¸¬äººè‡‰çš„æ™‚é–“ï¼ˆé¿å…é »ç¹åµæ¸¬ï¼‰
last_face_detection_time = {}

async def handle_frame(session_id: str, data: dict):
    """è™•ç†å½±åƒå½±æ ¼"""
    try:
        # è§£ç¢¼å½±åƒ
        frame_data = data.get("frame")
        if not frame_data:
            return

        if "," in frame_data:
            frame_data = frame_data.split(",")[1]

        image_bytes = base64.b64decode(frame_data)
        nparr = np.frombuffer(image_bytes, np.uint8)
        frame = cv2.imdecode(nparr, cv2.IMREAD_COLOR)

        if frame is None:
            return

        session = manager.get_session(session_id)

        # äººè‡‰è­˜åˆ¥ï¼ˆåƒ…åœ¨æœªç™»å…¥æ™‚åŸ·è¡Œï¼Œä¸”é–“éš” > 1 ç§’ï¼‰
        if not session.get('user_id'):
            current_time = datetime.utcnow().timestamp()
            last_time = last_face_detection_time.get(session_id, 0)

            if current_time - last_time > 1.0:  # 1 ç§’é–“éš”
                last_face_detection_time[session_id] = current_time
                await handle_face_detection(session_id, frame)

        # YOLO å•†å“åµæ¸¬ï¼ˆåƒ…åœ¨å·²ç™»å…¥æ™‚åŸ·è¡Œï¼‰
        elif session.get('user_id'):
            detections = yolo_service.detect(frame)

            if detections:
                await manager.send_message(session_id, {
                    "type": "detections",
                    "detections": detections,
                    "timestamp": datetime.utcnow().isoformat()
                })

                for detection in detections:
                    product = detection.get('product')
                    if product:
                        await handle_product_detected(session_id, product, detection)

    except Exception as e:
        print(f"âŒ è™•ç†å½±æ ¼éŒ¯èª¤: {e}")

async def handle_face_detection(session_id: str, frame: np.ndarray):
    """è™•ç†äººè‡‰åµæ¸¬"""
    try:
        faces = face_service.detect_faces(frame)

        if not faces:
            return

        # å–ç¬¬ä¸€å¼µè‡‰
        face_encoding, face_location = faces[0]
        top, right, bottom, left = face_location

        # å˜—è©¦æ¯”å°
        matched_user = face_service.match_face(face_encoding)

        if matched_user:
            # æ‰¾åˆ°å·²çŸ¥ä½¿ç”¨è€…ï¼Œè‡ªå‹•ç™»å…¥
            session = manager.get_session(session_id)
            session['user_id'] = matched_user['id']

            await manager.send_message(session_id, {
                "type": "face_detected",
                "action": "login",
                "user": matched_user,
                "bbox": [left, top, right, bottom]
            })

            print(f"âœ… ä½¿ç”¨è€…ç™»å…¥: {matched_user['name']}")

        else:
            # æ–°ä½¿ç”¨è€…ï¼Œè«‹æ±‚è¨»å†Š
            # è£åˆ‡äººè‡‰åœ–ç‰‡
            face_image = frame[top:bottom, left:right]

            # æš«å­˜äººè‡‰è³‡æ–™
            session = manager.get_session(session_id)
            session['pending_face'] = {
                'encoding': face_encoding,
                'image': face_image,
                'location': [left, top, right, bottom]
            }

            await manager.send_message(session_id, {
                "type": "face_detected",
                "action": "register_prompt",
                "bbox": [left, top, right, bottom]
            })

            print(f"ğŸ‘¤ åµæ¸¬åˆ°æ–°äººè‡‰ï¼Œç­‰å¾…è¨»å†Š")

    except Exception as e:
        print(f"âŒ äººè‡‰åµæ¸¬è™•ç†éŒ¯èª¤: {e}")

# æ–°å¢ API ç«¯é»ï¼šä½¿ç”¨è€…è¨»å†Š
@app.post("/api/register")
async def register_user(data: dict):
    """è¨»å†Šæ–°ä½¿ç”¨è€…"""
    try:
        session_id = data.get("session_id")
        name = data.get("name")
        phone = data.get("phone")

        if not all([session_id, name, phone]):
            raise HTTPException(status_code=400, detail="ç¼ºå°‘å¿…è¦æ¬„ä½")

        session = manager.get_session(session_id)
        pending_face = session.get('pending_face')

        if not pending_face:
            raise HTTPException(status_code=400, detail="æ‰¾ä¸åˆ°å¾…è¨»å†Šçš„äººè‡‰")

        # è¨»å†Šä½¿ç”¨è€…
        user = face_service.register_user(
            name=name,
            phone=phone,
            face_encoding=pending_face['encoding'],
            face_image=pending_face['image']
        )

        # è‡ªå‹•ç™»å…¥
        session['user_id'] = user['id']
        del session['pending_face']

        return JSONResponse(content={
            "success": True,
            "user": user
        })

    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è¨»å†Šå¤±æ•—: {str(e)}")
```

### å‰ç«¯è¨»å†Šè¡¨å–®èˆ‡ä½¿ç”¨è€…é¡¯ç¤º

ä¿®æ”¹ `frontend/static/js/main.js`ï¼š

```javascript
// ç›£è½äººè‡‰åµæ¸¬
wsClient.on('face_detected', (data) => {
    if (data.action === 'login') {
        console.log('âœ… ä½¿ç”¨è€…ç™»å…¥:', data.user);
        updateUserInfo(data.user);
        enableCheckout();
    } else if (data.action === 'register_prompt') {
        console.log('ğŸ‘¤ åµæ¸¬åˆ°æ–°äººè‡‰ï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®');
        showRegisterForm();
    }
});

function showRegisterForm() {
    // é¡¯ç¤ºè¨»å†Šè¡¨å–®ï¼ˆç°¡å–®çš„ promptï¼Œå¯æ”¹ç‚ºæ›´ç¾è§€çš„ modalï¼‰
    const name = prompt('è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š');
    if (!name) return;

    const phone = prompt('è«‹è¼¸å…¥æ‚¨çš„é›»è©±ï¼š');
    if (!phone) return;

    // ç™¼é€è¨»å†Šè«‹æ±‚
    fetch('/api/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: wsClient.sessionId,
            name: name,
            phone: phone
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log('âœ… è¨»å†ŠæˆåŠŸ:', data.user);
            updateUserInfo(data.user);
            enableCheckout();
            alert('è¨»å†ŠæˆåŠŸï¼æ­¡è¿ä½¿ç”¨æ™ºæ…§å•†åº—ç³»çµ±');
        }
    })
    .catch(err => {
        console.error('âŒ è¨»å†Šå¤±æ•—:', err);
        alert('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    });
}

function updateUserInfo(user) {
    const userInfoEl = document.getElementById('user-info');
    userInfoEl.innerHTML = `
        <div class="user-details">
            <h3>æ­¡è¿ï¼Œ${user.name} ğŸ‘‹</h3>
            <p>ğŸ“ ${user.phone}</p>
        </div>
    `;
}

function enableCheckout() {
    document.getElementById('checkout-btn').disabled = false;
}
```

### è³‡æ–™æ¨¡å‹ï¼ˆmodels/user.pyï¼‰

```python
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime

class User(BaseModel):
    """ä½¿ç”¨è€…è³‡æ–™æ¨¡å‹"""
    id: Optional[str] = Field(None, alias='_id')
    name: str
    phone: str
    face_encoding: List[float]  # 128-d vector
    face_image_path: str
    created_at: datetime = Field(default_factory=datetime.utcnow)
    last_visit: datetime = Field(default_factory=datetime.utcnow)

    class Config:
        populate_by_name = True
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

## Dependencies

- [ ] Task 001 å®Œæˆï¼ˆå°ˆæ¡ˆçµæ§‹å’Œè³‡æ–™åº«ï¼‰
- [ ] Task 002 å®Œæˆï¼ˆFastAPI å’Œ WebSocketï¼‰
- [ ] face_recognition å¥—ä»¶å·²å®‰è£
- [ ] `data/faces/` ç›®éŒ„å¯å¯«å…¥

## Effort Estimate

- **Size**: L (Large)
- **Hours**: 6-8 å°æ™‚
- **Parallel**: trueï¼ˆå¯èˆ‡ Task 004 åŒæ™‚é–‹ç™¼ï¼‰

**æ™‚é–“åˆ†é…**ï¼š
- FaceService é¡åˆ¥å¯¦ä½œï¼š3 å°æ™‚
- æ•´åˆè‡³ main.pyï¼š1.5 å°æ™‚
- å‰ç«¯è¨»å†Šè¡¨å–®å’Œé¡¯ç¤ºï¼š1 å°æ™‚
- æ¸¬è©¦ï¼ˆä¸åŒäººè‡‰ã€å…‰ç·šæ¢ä»¶ï¼‰ï¼š2-2.5 å°æ™‚

## Definition of Done

- [ ] ç¬¬ä¸€æ¬¡ç«™åœ¨é¡é ­å‰å½ˆå‡ºè¨»å†Šè¡¨å–®
- [ ] è¼¸å…¥å§“åå’Œé›»è©±å¾Œè¨»å†ŠæˆåŠŸ
- [ ] MongoDB Users Collection åŒ…å«æ–°ä½¿ç”¨è€…è³‡æ–™
- [ ] `data/faces/` ç›®éŒ„åŒ…å«äººè‡‰åœ–ç‰‡
- [ ] å·¦å´é¢æ¿é¡¯ç¤ºä½¿ç”¨è€…å§“åå’Œé›»è©±
- [ ] å†æ¬¡ç«™åœ¨é¡é ­å‰è‡ªå‹•è­˜åˆ¥ä¸¦é¡¯ç¤ºã€Œæ­¡è¿å›ä¾†ï¼ŒXXXã€
- [ ] ä¸åŒäººè‡‰ä¸æœƒè¢«èª¤èªç‚ºåŒä¸€äºº
- [ ] ç›¸åŒäººè‡‰åœ¨ä¸åŒå…‰ç·šä¸‹ä»èƒ½æ­£ç¢ºè­˜åˆ¥ï¼ˆ> 90% æˆåŠŸç‡ï¼‰
- [ ] è­˜åˆ¥å»¶é² < 2 ç§’
- [ ] ã€Œå®Œæˆçµå¸³ã€æŒ‰éˆ•åœ¨ç™»å…¥å¾Œå•Ÿç”¨
- [ ] Console æ­£ç¢ºé¡¯ç¤ºæ—¥èªŒï¼ˆåµæ¸¬ã€æ¯”å°ã€è¨»å†Šã€ç™»å…¥ï¼‰
- [ ] é•·æ™‚é–“é‹è¡Œç„¡è¨˜æ†¶é«”æ´©æ¼
