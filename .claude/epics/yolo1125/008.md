---
name: ç³»çµ±æ•´åˆæ¸¬è©¦ã€æ•ˆèƒ½å„ªåŒ–èˆ‡ Bug ä¿®å¾©
status: open
created: 2025-10-30T05:02:17Z
updated: 2025-10-30T05:02:17Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002, 003, 004, 005, 006, 007]
parallel: false
conflicts_with: []
---

# Task: ç³»çµ±æ•´åˆæ¸¬è©¦ã€æ•ˆèƒ½å„ªåŒ–èˆ‡ Bug ä¿®å¾©

## Description

é€²è¡Œå®Œæ•´çš„ç³»çµ±æ•´åˆæ¸¬è©¦ï¼Œé©—è­‰æ‰€æœ‰åŠŸèƒ½ç«¯åˆ°ç«¯é‹ä½œæ­£å¸¸ï¼Œé€²è¡Œæ•ˆèƒ½å„ªåŒ–ä»¥ç¬¦åˆ PRD è¦æ±‚ï¼Œä¿®å¾©æ¸¬è©¦ä¸­ç™¼ç¾çš„ Bugï¼Œä¸¦å®Œå–„éŒ¯èª¤è™•ç†å’Œä½¿ç”¨è€…é«”é©—ã€‚

**æ ¸å¿ƒç›®æ¨™**ï¼š
- ç«¯åˆ°ç«¯åŠŸèƒ½æ¸¬è©¦ï¼ˆæ–°ä½¿ç”¨è€…è¨»å†Š â†’ å›è¨ªè­˜åˆ¥ â†’ è³¼ç‰© â†’ çµå¸³ï¼‰
- æ•ˆèƒ½æ¸¬è©¦å’Œå„ªåŒ–ï¼ˆå›æ‡‰æ™‚é–“ã€è¨˜æ†¶é«”ä½¿ç”¨ï¼‰
- é‚Šç•Œæ¸¬è©¦ï¼ˆéŒ¯èª¤æƒ…æ³ã€ç•°å¸¸è¼¸å…¥ï¼‰
- Bug ä¿®å¾©å’Œç¨‹å¼ç¢¼å„ªåŒ–
- ä½¿ç”¨è€…é«”é©—æ”¹å–„
- æ’°å¯« README å’Œéƒ¨ç½²æ–‡ä»¶

## Acceptance Criteria

- [ ] å®Œæ•´è³¼ç‰©æµç¨‹æ¸¬è©¦é€šéï¼ˆ10 æ¬¡æ¸¬è©¦ç„¡å¤±æ•—ï¼‰
- [ ] æ•ˆèƒ½ç¬¦åˆ PRD è¦æ±‚ï¼š
  - äººè‡‰è­˜åˆ¥ < 2 ç§’
  - å•†å“è­˜åˆ¥ < 1 ç§’
  - WebSocket å»¶é² < 100ms
- [ ] ç³»çµ±ç©©å®šé‹è¡Œ 2 å°æ™‚ç„¡å´©æ½°
- [ ] è™•ç† 20 ç­†äº¤æ˜“ç„¡éŒ¯èª¤
- [ ] æ‰€æœ‰éŒ¯èª¤æƒ…æ³æœ‰é©ç•¶è™•ç†
- [ ] README.md åŒ…å«å®Œæ•´çš„å®‰è£å’Œä½¿ç”¨èªªæ˜
- [ ] ç¨‹å¼ç¢¼è¨»è§£å®Œæ•´
- [ ] å·²çŸ¥ Bug å…¨éƒ¨ä¿®å¾©

## Technical Details

### 1. ç«¯åˆ°ç«¯æ¸¬è©¦è…³æœ¬

```python
# scripts/e2e_test.py
"""
ç«¯åˆ°ç«¯æ¸¬è©¦è…³æœ¬
æ¸¬è©¦å®Œæ•´çš„ä½¿ç”¨è€…æµç¨‹
"""
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

import cv2
import time
from backend.services.face_service import face_service
from backend.services.yolo_service import yolo_service
from backend.services.cart_service import cart_service
from backend.database import Database

def test_e2e():
    """ç«¯åˆ°ç«¯æ¸¬è©¦"""
    print("="*60)
    print("é–‹å§‹ç«¯åˆ°ç«¯æ¸¬è©¦")
    print("="*60)

    # é€£æ¥è³‡æ–™åº«
    db = Database.connect()

    # æ¸¬è©¦ 1: YOLO æ¨¡å‹è¼‰å…¥
    print("\n[æ¸¬è©¦ 1] YOLO æ¨¡å‹è¼‰å…¥")
    assert yolo_service.model is not None, "YOLO æ¨¡å‹æœªè¼‰å…¥"
    print("âœ… YOLO æ¨¡å‹æ­£å¸¸")

    # æ¸¬è©¦ 2: äººè‡‰è­˜åˆ¥æœå‹™
    print("\n[æ¸¬è©¦ 2] äººè‡‰è­˜åˆ¥æœå‹™")
    known_faces_count = len(face_service.known_faces)
    print(f"âœ… å·²è¼‰å…¥ {known_faces_count} å€‹å·²çŸ¥äººè‡‰")

    # æ¸¬è©¦ 3: è³¼ç‰©è»ŠåŠŸèƒ½
    print("\n[æ¸¬è©¦ 3] è³¼ç‰©è»ŠåŠŸèƒ½")
    session_id = "e2e_test"
    product = {'id': 'test1', 'name': 'æ¸¬è©¦å•†å“', 'price': 100.0}

    cart_service.add_item(session_id, product)
    cart = cart_service.get_cart_summary(session_id)
    assert cart['total_quantity'] == 1, "è³¼ç‰©è»Šæ•¸é‡éŒ¯èª¤"
    assert cart['total_amount'] == 100.0, "è³¼ç‰©è»Šé‡‘é¡éŒ¯èª¤"

    cart_service.add_item(session_id, product)
    cart = cart_service.get_cart_summary(session_id)
    assert cart['total_quantity'] == 2, "è³¼ç‰©è»Šç´¯åŠ éŒ¯èª¤"

    cart_service.clear_cart(session_id)
    print("âœ… è³¼ç‰©è»ŠåŠŸèƒ½æ­£å¸¸")

    # æ¸¬è©¦ 4: è³‡æ–™åº«é€£ç·š
    print("\n[æ¸¬è©¦ 4] è³‡æ–™åº«é€£ç·š")
    products_count = db.products.count_documents({})
    users_count = db.users.count_documents({})
    txn_count = db.transactions.count_documents({})

    print(f"   å•†å“æ•¸é‡: {products_count}")
    print(f"   ä½¿ç”¨è€…æ•¸é‡: {users_count}")
    print(f"   äº¤æ˜“è¨˜éŒ„: {txn_count}")
    print("âœ… è³‡æ–™åº«æ­£å¸¸")

    print("\n" + "="*60)
    print("âœ… æ‰€æœ‰æ¸¬è©¦é€šé")
    print("="*60)

if __name__ == "__main__":
    test_e2e()
```

### 2. æ•ˆèƒ½æ¸¬è©¦è…³æœ¬

```python
# scripts/performance_test.py
"""æ•ˆèƒ½æ¸¬è©¦"""
import sys
from pathlib import Path
import time
import cv2
import numpy as np

sys.path.insert(0, str(Path(__file__).parent.parent))

from backend.services.face_service import face_service
from backend.services.yolo_service import yolo_service

def measure_time(func, *args, **kwargs):
    """æ¸¬é‡å‡½å¼åŸ·è¡Œæ™‚é–“"""
    start = time.time()
    result = func(*args, **kwargs)
    end = time.time()
    return result, (end - start) * 1000  # è½‰æ›ç‚ºæ¯«ç§’

def test_performance():
    """æ•ˆèƒ½æ¸¬è©¦"""
    print("é–‹å§‹æ•ˆèƒ½æ¸¬è©¦...\n")

    # æº–å‚™æ¸¬è©¦å½±åƒ
    test_image_dir = Path("dataset/images/train")
    test_images = list(test_image_dir.glob("*.jpg"))[:5]

    if not test_images:
        print("âŒ æ‰¾ä¸åˆ°æ¸¬è©¦åœ–ç‰‡")
        return

    # æ¸¬è©¦ YOLO åµæ¸¬é€Ÿåº¦
    print("[1] YOLO å•†å“åµæ¸¬æ•ˆèƒ½")
    yolo_times = []

    for img_path in test_images:
        frame = cv2.imread(str(img_path))
        if frame is None:
            continue

        _, elapsed = measure_time(yolo_service.detect, frame)
        yolo_times.append(elapsed)

    avg_yolo_time = sum(yolo_times) / len(yolo_times)
    print(f"   å¹³å‡åµæ¸¬æ™‚é–“: {avg_yolo_time:.2f} ms")
    print(f"   æœ€å°/æœ€å¤§: {min(yolo_times):.2f} / {max(yolo_times):.2f} ms")

    if avg_yolo_time < 1000:
        print(f"   âœ… ç¬¦åˆè¦æ±‚ (< 1000 ms)")
    else:
        print(f"   âš ï¸ è¶…éè¦æ±‚ (å»ºè­°å•Ÿç”¨ GPU åŠ é€Ÿ)")

    # æ¸¬è©¦äººè‡‰è­˜åˆ¥é€Ÿåº¦
    print("\n[2] äººè‡‰è­˜åˆ¥æ•ˆèƒ½")
    # ä½¿ç”¨æ¸¬è©¦åœ–ç‰‡ï¼ˆéœ€åŒ…å«äººè‡‰ï¼‰
    # é€™è£¡ç°¡åŒ–æ¸¬è©¦ï¼Œå¯¦éš›æ‡‰ä½¿ç”¨åŒ…å«äººè‡‰çš„åœ–ç‰‡

    print("   ï¼ˆéœ€è¦åŒ…å«äººè‡‰çš„æ¸¬è©¦åœ–ç‰‡ï¼‰")

    # æ¸¬è©¦è³¼ç‰©è»Šæ“ä½œé€Ÿåº¦
    print("\n[3] è³¼ç‰©è»Šæ“ä½œæ•ˆèƒ½")
    from backend.services.cart_service import cart_service

    session_id = "perf_test"
    product = {'id': 'test', 'name': 'æ¸¬è©¦', 'price': 100}

    _, elapsed = measure_time(cart_service.add_item, session_id, product)
    print(f"   åŠ å…¥å•†å“: {elapsed:.2f} ms")

    _, elapsed = measure_time(cart_service.get_cart_summary, session_id)
    print(f"   å–å¾—è³¼ç‰©è»Š: {elapsed:.2f} ms")

    _, elapsed = measure_time(cart_service.remove_item, session_id, 0)
    print(f"   ç§»é™¤å•†å“: {elapsed:.2f} ms")

    print("   âœ… è³¼ç‰©è»Šæ“ä½œæ­£å¸¸")

    print("\nâœ… æ•ˆèƒ½æ¸¬è©¦å®Œæˆ")

if __name__ == "__main__":
    test_performance()
```

### 3. éŒ¯èª¤è™•ç†æ”¹å–„

#### é¡é ­å­˜å–éŒ¯èª¤è™•ç†ï¼ˆcamera.jsï¼‰

```javascript
async start() {
    try {
        this.stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 640 }, height: { ideal: 480 } },
            audio: false
        });

        this.video.srcObject = this.stream;
        this.isRunning = true;

        await new Promise((resolve) => {
            this.video.onloadedmetadata = () => {
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                resolve();
            };
        });

        console.log('âœ… é¡é ­å•Ÿå‹•æˆåŠŸ');
        this.hideError();
        this.startDrawing();

    } catch (error) {
        console.error('âŒ é¡é ­å­˜å–å¤±æ•—:', error);

        let errorMessage = 'ç„¡æ³•å­˜å–é¡é ­';

        if (error.name === 'NotAllowedError') {
            errorMessage = 'è«‹å…è¨±é¡é ­æ¬Šé™';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'æ‰¾ä¸åˆ°é¡é ­è¨­å‚™';
        } else if (error.name === 'NotReadableError') {
            errorMessage = 'é¡é ­æ­£è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨';
        }

        this.showError(errorMessage);
    }
}

showError(message) {
    const errorEl = document.getElementById('camera-error');
    errorEl.textContent = 'âŒ ' + message;
    errorEl.style.display = 'block';
}
```

#### WebSocket æ–·ç·šé‡é€£ï¼ˆwebsocket.jsï¼‰

```javascript
class WebSocketClient {
    constructor(url) {
        this.url = url;
        this.ws = null;
        this.sessionId = this.generateSessionId();
        this.connected = false;
        this.messageHandlers = {};
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
    }

    connect() {
        const wsUrl = `${this.url}/${this.sessionId}`;
        this.ws = new WebSocket(wsUrl);

        this.ws.onopen = () => {
            console.log('âœ… WebSocket é€£ç·šæˆåŠŸ');
            this.connected = true;
            this.reconnectAttempts = 0;
            this.updateStatus(true);
        };

        this.ws.onclose = () => {
            console.log('âŒ WebSocket æ–·ç·š');
            this.connected = false;
            this.updateStatus(false);

            // è‡ªå‹•é‡é€£
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                this.reconnectAttempts++;
                const delay = Math.min(1000 * this.reconnectAttempts, 5000);
                console.log(`â³ ${delay/1000} ç§’å¾Œé‡æ–°é€£ç·š... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                setTimeout(() => this.connect(), delay);
            } else {
                console.error('âŒ å·²é”æœ€å¤§é‡é€£æ¬¡æ•¸ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                alert('é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        };

        this.ws.onerror = (error) => {
            console.error('âŒ WebSocket éŒ¯èª¤:', error);
        };

        this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleMessage(data);
        };
    }
}
```

### 4. README.md

```markdown
# YOLO1125 æ™ºæ…§ç„¡äººå•†åº—ç³»çµ±

çµåˆ YOLO ç‰©å“è¾¨è­˜èˆ‡äººè‡‰è­˜åˆ¥çš„æ™ºæ…§çµå¸³ç³»çµ±ã€‚

## åŠŸèƒ½ç‰¹è‰²

- ğŸ¯ YOLO å•†å“è­˜åˆ¥ï¼ˆå…ƒç¿ èŒ¶ã€åˆ†è§£èŒ¶ï¼‰
- ğŸ‘¤ äººè‡‰è­˜åˆ¥è‡ªå‹•ç™»å…¥
- ğŸ›’ å³æ™‚è³¼ç‰©è»Šç®¡ç†
- ğŸ’° è‡ªå‹•çµå¸³èˆ‡äº¤æ˜“è¨˜éŒ„
- ğŸ“± éŸ¿æ‡‰å¼ç¶²é ä»‹é¢

## ç³»çµ±éœ€æ±‚

### ç¡¬é«”
- é›»è…¦ï¼ˆ8GB+ RAM å»ºè­°ï¼‰
- ç¶²è·¯æ”å½±æ©Ÿ
- ï¼ˆé¸ç”¨ï¼‰NVIDIA GPUï¼ˆåŠ é€Ÿ YOLO æ¨è«–ï¼‰

### è»Ÿé«”
- Python 3.8+
- MongoDB 6.0+
- ç¾ä»£ç€è¦½å™¨ï¼ˆChrome, Edge, Firefoxï¼‰

## å®‰è£æ­¥é©Ÿ

### 1. å®‰è£ MongoDB

**macOS (Homebrew)**:
\`\`\`bash
brew tap mongodb/brew
brew install mongodb-community@6.0
brew services start mongodb-community@6.0
\`\`\`

**Ubuntu**:
\`\`\`bash
sudo apt-get install -y mongodb
sudo systemctl start mongodb
\`\`\`

### 2. å…‹éš†å°ˆæ¡ˆ

\`\`\`bash
cd /path/to/yolo1125
\`\`\`

### 3. å®‰è£ Python ä¾è³´

\`\`\`bash
pip install -r requirements.txt
\`\`\`

### 4. åˆå§‹åŒ–è³‡æ–™åº«

\`\`\`bash
python scripts/init_db.py
\`\`\`

## å•Ÿå‹•ç³»çµ±

\`\`\`bash
python backend/main.py
\`\`\`

é–‹å•Ÿç€è¦½å™¨è¨ªå•ï¼š`http://localhost:8000`

## ä½¿ç”¨æµç¨‹

1. **é¦–æ¬¡ä½¿ç”¨**ï¼š
   - ç«™åœ¨é¡é ­å‰
   - è¼¸å…¥å§“åå’Œé›»è©±è¨»å†Š
   - ç³»çµ±å„²å­˜äººè‡‰è³‡æ–™

2. **å›è¨ªä½¿ç”¨**ï¼š
   - ç«™åœ¨é¡é ­å‰è‡ªå‹•è­˜åˆ¥
   - é–‹å§‹è³¼ç‰©

3. **è³¼ç‰©**ï¼š
   - å±•ç¤ºå•†å“çµ¦é¡é ­
   - å•†å“è‡ªå‹•åŠ å…¥è³¼ç‰©è»Š
   - å¯æ‰‹å‹•ç§»é™¤å•†å“

4. **çµå¸³**ï¼š
   - é»æ“Šã€Œå®Œæˆçµå¸³ã€
   - ç¢ºèªé‡‘é¡
   - å®Œæˆäº¤æ˜“

## æ¸¬è©¦

\`\`\`bash
# ç«¯åˆ°ç«¯æ¸¬è©¦
python scripts/e2e_test.py

# æ•ˆèƒ½æ¸¬è©¦
python scripts/performance_test.py

# æŸ¥çœ‹äº¤æ˜“è¨˜éŒ„
python scripts/view_transactions.py
\`\`\`

## å°ˆæ¡ˆçµæ§‹

\`\`\`
yolo1125/
â”œâ”€â”€ backend/          # å¾Œç«¯ç¨‹å¼
â”‚   â”œâ”€â”€ main.py       # FastAPI ä¸»ç¨‹å¼
â”‚   â”œâ”€â”€ models/       # è³‡æ–™æ¨¡å‹
â”‚   â””â”€â”€ services/     # æ¥­å‹™é‚è¼¯
â”œâ”€â”€ frontend/         # å‰ç«¯é é¢
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ static/       # CSS/JS
â”œâ”€â”€ data/             # è³‡æ–™ç›®éŒ„
â”‚   â””â”€â”€ faces/        # äººè‡‰åœ–ç‰‡
â”œâ”€â”€ runs/             # YOLO æ¨¡å‹
â””â”€â”€ scripts/          # å·¥å…·è…³æœ¬
\`\`\`

## æ•…éšœæ’é™¤

### é¡é ­ç„¡æ³•å•Ÿå‹•
- æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®š
- ç¢ºèªé¡é ­æœªè¢«å…¶ä»–ç¨‹å¼ä½”ç”¨

### MongoDB é€£ç·šå¤±æ•—
\`\`\`bash
# æª¢æŸ¥ MongoDB ç‹€æ…‹
mongosh

# é‡æ–°å•Ÿå‹•æœå‹™
brew services restart mongodb-community@6.0  # macOS
sudo systemctl restart mongodb               # Linux
\`\`\`

### YOLO æ¨¡å‹æœªæ‰¾åˆ°
- ç¢ºèª `runs/detect/train/weights/best.pt` å­˜åœ¨
- æª¢æŸ¥ `backend/config.py` ä¸­çš„è·¯å¾‘è¨­å®š

## æˆæ¬Š

MIT License

## é–‹ç™¼åœ˜éšŠ

YOLO1125 Development Team
\`\`\`

### 5. ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥

```python
# scripts/code_quality.py
"""ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥"""
import subprocess
import sys

def run_checks():
    print("åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥...\n")

    # æª¢æŸ¥ Python èªæ³•
    print("[1] Python èªæ³•æª¢æŸ¥")
    result = subprocess.run(
        ["python", "-m", "py_compile", "backend/main.py"],
        capture_output=True
    )
    if result.returncode == 0:
        print("âœ… èªæ³•æ­£ç¢º")
    else:
        print("âŒ èªæ³•éŒ¯èª¤")
        print(result.stderr.decode())

    # æª¢æŸ¥åŒ¯å…¥
    print("\n[2] åŒ¯å…¥æª¢æŸ¥")
    try:
        import backend.main
        import backend.database
        import backend.config
        print("âœ… æ‰€æœ‰æ¨¡çµ„å¯æ­£å¸¸åŒ¯å…¥")
    except ImportError as e:
        print(f"âŒ åŒ¯å…¥éŒ¯èª¤: {e}")

    print("\nâœ… ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ")

if __name__ == "__main__":
    run_checks()
```

## Dependencies

- [ ] æ‰€æœ‰å‰ç½®ä»»å‹™ï¼ˆTask 001-007ï¼‰å®Œæˆ
- [ ] ç³»çµ±å¯å®Œæ•´é‹è¡Œ

## Effort Estimate

- **Size**: M (Medium)
- **Hours**: 4-6 å°æ™‚
- **Parallel**: falseï¼ˆéœ€æ‰€æœ‰åŠŸèƒ½å®Œæˆï¼‰

**æ™‚é–“åˆ†é…**ï¼š
- ç«¯åˆ°ç«¯æ¸¬è©¦ï¼š1.5 å°æ™‚
- æ•ˆèƒ½æ¸¬è©¦å’Œå„ªåŒ–ï¼š1.5 å°æ™‚
- Bug ä¿®å¾©ï¼š1 å°æ™‚
- æ–‡ä»¶æ’°å¯«ï¼š1 å°æ™‚
- æœ€çµ‚é©—è­‰ï¼š1 å°æ™‚

## Definition of Done

- [ ] åŸ·è¡Œ `python scripts/e2e_test.py` å…¨éƒ¨é€šé
- [ ] åŸ·è¡Œ `python scripts/performance_test.py` ç¬¦åˆæ•ˆèƒ½è¦æ±‚
- [ ] å®Œæ•´è³¼ç‰©æµç¨‹æ¸¬è©¦ 10 æ¬¡ç„¡å¤±æ•—
- [ ] ç³»çµ±é€£çºŒé‹è¡Œ 2 å°æ™‚ç„¡å´©æ½°
- [ ] è™•ç† 20 ç­†äº¤æ˜“ç„¡éŒ¯èª¤
- [ ] README.md å®Œæ•´ä¸”å¯æŒ‰æ­¥é©Ÿæ“ä½œæˆåŠŸ
- [ ] æ‰€æœ‰å·²çŸ¥ Bug ä¿®å¾©
- [ ] éŒ¯èª¤æƒ…æ³æœ‰é©ç•¶æç¤ºè¨Šæ¯
- [ ] ç¨‹å¼ç¢¼æœ‰é©ç•¶è¨»è§£
- [ ] ç„¡ console è­¦å‘Šæˆ–éŒ¯èª¤ï¼ˆæ­£å¸¸ä½¿ç”¨æƒ…æ³ä¸‹ï¼‰
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ç©©å®šï¼ˆç„¡æ˜é¡¯æ´©æ¼ï¼‰
- [ ] äº¤ä»˜çµ¦ä½¿ç”¨è€…å¯ç›´æ¥ä½¿ç”¨
